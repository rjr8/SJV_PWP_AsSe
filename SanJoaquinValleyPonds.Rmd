---
title: "San Joaquin Valley Ponds"
author: "Rob Rossi"
date: "1/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
#knitr::opts_knit$set(root.dir = 
 #                      '~/Produced Water/CV_Ponds/CompositionPaper2022/')

# Establish directory
here::i_am('SJV_Composition.Rproj')

# Load script of custom functions
source('Rcustomfunctions.R')

```





## Initialize

```{r Setup, message=FALSE, warning=FALSE, include=FALSE}
# setup packages
req.packages = c('rstatix', 'sf', 'magrittr', 'hydrogeo', 
                 'ggpubr', 'pals', 'lubridate', 'iml', 'pdp',
                 'BAMMtools', 'corrplot', 'here', 'caret', 'MASS',
                 'RColorBrewer', 'moments', 'Hmisc', 'tidyverse')
setupPackages(req.packages)

# install and load randomForest for R 4.0.3
#urlPackage = 'https://cran.r-project.org/src/contrib/Archive/randomForest/randomForest_4.6-14.tar.gz'
#install.packages(urlPackage, repos=NULL, type="source") 
library('randomForest')

# setup visualization options
theme_set(theme_classic2(base_family = 'Arial'))

```

## Load and Clean Data

### Geospatial Data

```{r Load sample geospatial data}

load(here('geospatial_data','SJVspatialData.Rda')) 

```


### Chemical Data

#### External Geochemical Endmember Data

```{r Load external data for analyses}
# Load Geochemical endmember data
load('Data/CAprodWater.Rda') # USGS SJV produced water
load('Data/USGS_NGDB_rock_SJV.Rda') # USGS Natl Geochem DB

load('Data/RockGeochemData.Rda') # CA rock geochemistry

load('Data/CalGEM_WSD.Rda') # CalGEM Well Stimulation Dataset

```

#### Raw Processing

```{r Load Raw Chemical Data, message=FALSE, warning=FALSE}

# Load raw chemical data
load(here('geochemical_data','SJVPondsDat_raw.Rda'))

```

### Clean Chemical Data

```{r Clean data, message=FALSE, warning=FALSE}

# Define which columns are factors 
factors = c('Global_ID', 'Oil_Field', 'Facility_Name', 
            'County', 'Detect_Limit')

# These columns are not essential for any analyses 
dropCols = c('Link', 'Source_Type', 'Datum', 'Latitude', 
             'Longitude', 'Geography_Description')

# Create data frames of clean data and nondetects
createCleanandNDdfs(SJVPondsDat.raw, name ='SJVPondsDat',
                    factorCols = factors, colsToDrop = dropCols,
                    firstChemDatColname = 'Alkalinity_CaCO3')
  
```


```{r Join spatial variables to dfs, message=FALSE, warning=FALSE}

# Join to cleaned data
SJVPondsDat.Clean %<>%
  left_join(SJV.spatial.vars, by = c('Int_ID' = 'Int_ID'))

# Join to non-detects
SJVPondsDat.ND %<>%
  left_join(SJV.spatial.vars, by = c('Int_ID' = 'Int_ID'))
```


```{r Calc Charge Balances and Molar Ratios, message=FALSE, warning=FALSE}

# Calculate sample charge balances
SJVPondsDat.Clean %<>%
  calcChargeBalance(., CBerrorFlag = 20, uniqueIdentifier = 'Int_ID')

# Calculate sample molar ratios
SJVPondsDat.Clean %<>% calcElementalRatios(.)

```


## Get the lay of the land

### Detection Counts

#### General Detection Counts

First create a data frame of just the counts of detects for each analyte
```{r Count Detects, message=FALSE, warning=FALSE}
detectsCounts = 
  SJVPondsDat.Clean %>%
  dplyr::select(c(10:length(.))) %>% 
  # Drop organics, spatial, and calculated variables
  dplyr::select(-c(76:237)) %>%
  # Drop non Total Alkalinities
  dplyr::select(-c(2:4)) %>%
  dplyr::summarise(across(everything(), countDetects)) %>%
  pivot_longer(cols = everything(),
               names_to ='Analyte',
               values_to = 'Detects') %>% 
  arrange(desc(Detects))

# Save list of analytes for future summarizing
summary.analytes = 
  SJVPondsDat.Clean %>%
  select(c(10:length(.))) %>% 
  # Drop organics, spatial, and calculated variables
  dplyr::select(-c(76:237)) %>%
  # Drop non Total Alkalinities
  dplyr::select(-c(2:4))%>%
  colnames(.)

```


#### Detailed Summary of Basin-wide Data

```{r Create list of analytes to summarise}

summary.analytes = c("Alkalinity_CaCO3", "Specific_Conductance", 
                     "TDS", "pH", "Na", "K", "Ca", "Mg", "Li", 
                     "Ba", "Sr", "HCO3", "CO3", "Cl", "SO4", "B", 
                     "Fe", "Mn", "NH4", "NO3", "As", "Se", 
                     "Oil_Grease", "Deuterium", "Oxygen_18")

```



Get the number of non-detections for each analyte
```{r Count NDs, message=FALSE, warning=FALSE}
nonDetects = 
  SJVPondsDat.ND %>%
  dplyr::select(all_of(summary.analytes)) %>%
  dplyr::summarise(across(everything(), ~sum(!is.na(.x)))) %>%
  pivot_longer(cols = everything(),
               names_to = "Analyte",
               values_to = "nondetects") %>%
  arrange(match(Analyte, summary.analytes))
```

Summarise each analyte
```{r Create summary table, message=FALSE, warning=FALSE}
detectsSummary = 
  SJVPondsDat.Clean %>%
  dplyr::select(all_of(summary.analytes)) %>% 
  pivot_longer(cols = everything(),
               names_to = "Analyte",
               values_to = "Concentration") %>%
  group_by(Analyte) %>%
  # Generate summary statistics of analytes
  dplyr::summarise(detects = sum(!is.na(Concentration)),
                   Min = min(Concentration, na.rm = TRUE),
                   Med = median(Concentration, na.rm = TRUE),
                   Max = max(Concentration, na.rm = TRUE),
                   `5th` = quantile(Concentration, probs = 0.05, na.rm = TRUE),
                   `25th` = quantile(Concentration, probs = 0.25, 
                                     na.rm = TRUE),
                   `75th` = quantile(Concentration, probs = 0.75, 
                                     na.rm = TRUE),
                   `95th` = quantile(Concentration, probs = 0.95, 
                                     na.rm = TRUE)) %>%
  arrange(match(Analyte, summary.analytes)) %>%
  # add in counts of non detections for each analyte
  add_column(NDs = nonDetects$nondetects, .after = "detects") %>%
  # round to 3 sigfigs
  dplyr::mutate(across(c(4:10), ~signif(.x, digits = 3))) %>%
  dplyr::mutate(`Detections (%)` = 
                  paste(as.character(detects),
                        paste(as.character(round(100*(detects/(detects + NDs)),
                                                 digits = 1)), sep =")"), 
                        sep = " ("), .after = Analyte) %>%
  dplyr::select(!c(detects, NDs))

# export summary table
write_csv(detectsSummary, "Tables/TableS1.csv")

```


This table is fine for the manuscript but I'll make a version that's friendlier for exploring




However from the top ten analytes a couple of things stand out 1. I think Ca will be the filtering variable for trying to predict concentrations (i.e., if Ca is present then there's likely more analytes than just SC, Cl, B), 2. to check the normality of the data it's prob not a bad idea to check a few analytes representing different quartiles to see if they all have similar distributions. What do those look like?


### Trace Metals

#### Detections

```{r Look at detection frequency of traces}

traces = c("Sb", "As", "Be", "Cd", "Cr", "CrVI", 
           "Co", "Cu", "Pb", "Mn", "Hg", "Mo", 
           "Ni", "Se", "Ag", "Tl", "V", "Zn")

detectsPerc =
  detectsSummary %>%
  # Separate Detections (%) column
  separate(`Detections (%)`, into = c("detects", "percent"), 
             sep = "\\s\\(", remove = TRUE, convert = TRUE)

# look at traces
detectsPerc %>%
  filter(Analyte %in% traces) %>%
  select(Analyte, detects, percent) %>%
   arrange(desc(percent))
```


```{r create df for plotting traces, message=FALSE, warning=FALSE}

Metals.plt.dat =
  SJVPondsDat.Clean %>%
  # Filter out suspect CBEs
  filter(CBE<20) %>%
  dplyr::select(c('Int_ID', 'Sample_ID', 'Oil_Field', 
                  'Facility_Name', 'AxisSide', 'As', 
                  'Mo', 'Mn', 'Hg', 'Ni', 'Cu',
                  'Se', 'Zn')) %>%
  pivot_longer(cols = As:Zn,
               names_to = 'Analyte',
               values_to = 'Conc')

```


```{r Plot Traces}
Metals.plt.dat %>%
  filter(AxisSide == 'West') %>%
  ggplot(aes(x = Oil_Field, y = Conc, fill = Analyte)) +
  geom_boxplot() + 
  facet_wrap(~Analyte, nrow = 4, scales = 'free_y') + 
  labs(title = '', x = '', y = 'Concentration (Âµg/L)') +
  scale_y_continuous(trans = 'log10') +
  scale_x_discrete(guide = guide_axis(n.dodge=3)) +
  theme(legend.position = 'top') +
  theme_classic2()

```


```{r}
SJVPondsDat.raw %>%
  filter(!is.na(As)) %>%
  group_by(Oil_Field) %>%
  summarise(count = n(), .groups = 'drop')
```


### Evapoconcentration examples


#### Arsenic

Arsenic seems to be related to EC, TDS, and Cl. I suspect this comes from rock weathering. First off I want to discount evaporative effects


```{r Selenium Evaporation plots}

ClBr.Se.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(!is.na(Se)) %>% arrange(Se) %>%
  ggplot() +
  geom_point(aes(x = Cl, y = Cl/Br, 
                 fill = cut_number(Se, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(0, 30000) +
  labs(title = "", x = "Cl (ppm)", y = "Cl/Br") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/ClBr_Se.pdf', plot = ClBr.Se.plt,
       width = 6, height = 3, units = 'in')


iso.Se.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(!is.na(Se)) %>% arrange(Se) %>%
  ggplot() +
  geom_abline(intercept = 10, slope = 8) + # GMWL
  geom_abline(intercept = 3.82, slope = 7.74, colour ='red') + # LMWL
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 fill = cut_number(Se, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", y = "H2 (permil)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/iso_Se.pdf', plot = iso.Se.plt,
       width = 6, height = 3, units = 'in')

```


```{r Coalinga evap, eval=FALSE, include=FALSE}
# Specific Facility
SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  filter(Oil_Field == 'COALINGA') %>%
  ggplot() +
  geom_point(aes(x = Cl, y = Cl/Br, colour = As)) +
  scale_color_distiller(palette = 'RdYlBu') +
  labs(title = "", x = "Cl (ppm)", y = "Cl/Br") +
  theme_classic2()

ggsave('Figures/Raw/COA_ClBr_As.pdf', plot = last_plot(),
       width = 4, height = 3, units = 'in')

SJVPondsDat.Clean %>%
  filter(!is.na(Se)) %>%
  filter(Oil_Field == 'COALINGA') %>%
  ggplot() +
  geom_point(aes(x = Cl, y = Cl/Br, colour = Se)) +
  scale_color_distiller(palette = 'RdYlBu') +
  labs(title = "", x = "Cl (ppm)", y = "Cl/Br") +
  #scale_size_continuous(range = c(0.1, 5)) +
  theme_classic2()

ggsave('Figures/Raw/COA_ClBr_Se.pdf', plot = last_plot(),
       width = 4, height = 3, units = 'in')

SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  filter(Oil_Field == 'COALINGA') %>%
  ggplot() +
  # GMWL
  geom_abline(intercept = 10, slope = 8) + 
  # LMWL
  geom_abline(intercept = 3.82, slope = 7.74) +
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 colour = As)) +
  scale_color_distiller(palette = 'RdYlBu') +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", 
       y = "H2 (permil)") +
  theme(legend.position = "none") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/COA_iso_As.pdf', plot = last_plot(),
       width = 4, height = 3, units = 'in')

SJVPondsDat.Clean %>%
  filter(!is.na(Se)) %>%
  filter(Oil_Field == 'COALINGA') %>%
  ggplot() +
  # GMWL
  geom_abline(intercept = 10, slope = 8) + 
  # LMWL
  geom_abline(intercept = 3.82, slope = 7.74) +
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 colour = Se)) +
  scale_color_distiller(palette = 'RdYlBu') +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", 
       y = "H2 (permil)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/COA_iso_Se.pdf', plot = last_plot(),
       width = 4, height = 3, units = 'in')
```



```{r Mercury Evaporation plot}

iso.Hg.plt =
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(!is.na(Hg)) %>% arrange(Hg) %>%
  ggplot() +
  geom_abline(intercept = 10, slope = 8) + # GMWL
  geom_abline(intercept = 3.82, slope = 7.74, colour ='red') + # LMWL
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 fill = cut_number(Hg, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", y = "H2 (permil)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/iso_Hg.pdf', plot = iso.Hg.plt,
       width = 6, height = 3, units = 'in')

```

```{r}
iso.Mo.plt =
  SJVPondsDat.Clean %>%
  filter(!is.na(Mo)) %>% arrange(Mo) %>%
  ggplot() +
  geom_abline(intercept = 10, slope = 8) + # GMWL
  geom_abline(intercept = 3.82, slope = 7.74, colour ='red') + # LMWL
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 fill = cut_number(Mo, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", y = "H2 (permil)") +
  theme_classic2()
```

```{r}
iso.Ni.plt =
  SJVPondsDat.Clean %>%
  filter(!is.na(Ni)) %>% arrange(Ni) %>%
  ggplot() +
  geom_abline(intercept = 10, slope = 8) + # GMWL
  geom_abline(intercept = 3.82, slope = 7.74, colour ='red') + # LMWL
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 fill = cut_number(Ni, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", y = "H2 (permil)") +
  theme_classic2()
```



```{r}
SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  #filter(Oil_Field == 'ANTELOPE HILLS' | Oil_Field == 'MIDWAY-SUNSET') %>%
  ggplot() +
  geom_point(aes(x = Ca.Mg, y = Ca.Sr,
                  colour = Oil_Field)) +
  labs(title = "", x = "Cl (ppm)", 
       y = "Cl/Br") +
  xlim(0, 10) +
  #scale_size_continuous(range = c(0.5, 8)) +
  #theme(legend.position = "none") +
  theme_classic2()


Ca.As.plt = 
  SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = Ca.Mg, y = Ca.Sr, colour = As)) +
  scale_x_continuous(trans='log10') +
  scale_y_continuous(trans='log10') +
  scale_color_distiller(palette = 'RdYlBu') +
  #xlim(0, 30000) +
  labs(title = "", x = "Ca/Mg (mol/mol)", y = "Ca/Sr (mol/mol)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/Ca_As.pdf', plot = Ca.As.plt,
       width = 4, height = 3, units = 'in')

Ca.Se.plt = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Se)) %>%
  ggplot() +
  geom_point(aes(x = Ca.Mg, y = Ca.Sr, colour = Se)) +
  scale_x_continuous(trans='log10') +
  scale_y_continuous(trans='log10') +
  scale_color_distiller(palette = 'RdYlBu') +
  #xlim(0, 30000) +
  labs(title = "", x = "Ca/Mg (mol/mol)", y = "Ca/Sr (mol/mol)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/Ca_Se.pdf', plot = Ca.Se.plt,
       width = 4, height = 3, units = 'in')

#Redox

FeMn.As.plt = 
  SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = (As/1e6)/74.91, y = (Fe/55.85)/(Mn/54.94))) +
  scale_x_continuous(trans='log10') +
  scale_y_continuous(trans='log10') +
  scale_color_distiller(palette = 'RdYlBu') +
 # ylim(0, 0.2) +
  labs(title = "", x = "As (mol)", y = "Fe/Mn (mol/mol)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/Ca_As.pdf', plot = FeMn.As.plt,
       width = 4, height = 3, units = 'in')

#Redox
FeMn.Se.plt = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Se)) %>%
  ggplot() +
  geom_point(aes(x = 1/((Se/1e6)/78.96), 
                 y = ((Fe/1000)/55.85)/((Mn/1e6)/54.94))) +
  scale_x_continuous(trans='log10') +
  scale_y_continuous(trans='log10') +
  scale_color_distiller(palette = 'RdYlBu') +
  #ylim(0, 1) +
  labs(title = "", x = "1/Se (mol)", y = "Fe/Mn (mol/mol)") +
  theme_classic2()

# save plot
ggsave('Figures/Raw/Ca_Se.pdf', plot = FeMn.Se.plt,
       width = 4, height = 3, units = 'in')

```
## Endmember Analysis
 
### Base Plots
 
```{r Create base plots}

# Ca/Mg vs Ca/Sr

Ca.rock =
  ggplot() +
  geom_point(data = USGS.NGDB.rock,
             aes(x = Ca.Mg, y = Ca.Sr, 
                 colour = as.factor(xndryclass)), shape = 15) +
  geom_point(data = Rock.chem %>% filter(County == 'San Benito'), 
             aes(x = Ca.Mg, y = Ca.Sr, 
                 colour = as.factor(RockType)), shape = 15) +
  scale_x_log10(limits = c(0.01, 100)) + 
  scale_y_log10(limits = c(0.01, 1000)) +
  theme_classic2() + 
  scale_colour_brewer(palette = "Greys", direction=-1,
                      na.value = "red")

ggsave('Figures/Raw/CaMg_CaSr_Rock.pdf', plot = Ca.rock,
       width = 4, height = 3, units = 'in')


Ca.PW = 
  CA.PW.database %>%
  filter(Formation %in% c('Temblor', NA, 'Etchegoin', 'San Joaquin',
                          'Monterey', 'Chanac', 'Tulare', 'Rio Bravo',
                          'Santa Margarita', 'Vedder', 'Jewett')) %>%
  ggplot() +
  geom_point(aes(x = Ca.Mg, y = Ca.Sr, colour = Formation), 
             shape = 17) +
  geom_point(data = CalGEM.WSD.chem %>% filter(Hg > 0), 
             aes(x = Ca.Mg, y = Ca.Sr), 
             shape = 15) +
  scale_x_log10(limits = c(0.01, 100)) + 
  scale_y_log10(limits = c(0.01, 1000)) +
  theme_classic2() +
  scale_colour_brewer(palette = "Paired", na.value="grey")

ggsave('Figures/Raw/CaMg_CaSr_PW.pdf', plot = Ca.PW,
       width = 4, height = 3, units = 'in')


# Mg/Na vs SO4/Cl

MgNa_SO4Cl.PW = 
  CA.PW.database %>%
  filter(Formation %in% c('Temblor', NA, 'Etchegoin', 'San Joaquin',
                          'Monterey', 'Chanac', 'Tulare', 'Rio Bravo',
                          'Santa Margarita', 'Vedder', 'Jewett')) %>%
  ggplot() + 
  geom_point(aes(x = Mg.Na, y = SO4.Cl, colour = Formation), 
             shape = 17) +
  scale_x_log10(limits = c(1e-5, 1e1)) + 
  scale_y_log10(limits = c(1e-5, 1e1)) +
  theme_classic2() +
  scale_colour_brewer(palette = "Paired", na.value="grey")

ggsave('Figures/Raw/MgNa_SO4Cl_PW.pdf', plot = MgNa_SO4Cl.PW,
       width = 4, height = 3, units = 'in')

# 1/Fe vs. Fe/Mn

Fe.As.rock =
  ggplot() +
  geom_point(data = USGS.NGDB.rock,
             aes(x = 1/(As*1.334935e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05), 
                 colour = as.factor(xndryclass)), shape = 15) +
  scale_colour_brewer(palette = "Greys", direction=-1,
                      na.value = "red") +
  #scale_x_log10(limits = c(1e-1, 1e7)) + 
  #scale_y_log10(limits = c(1e-1, 1e5)) +
  theme_classic2() 
  

ggsave('Figures/Raw/Fe_As_Rock.pdf', plot = Fe.As.rock,
       width = 4, height = 3, units = 'in')


Fe.PW = 
  CA.PW.database %>%
  filter(!is.na(Fe) | !is.na(Mn)) %>%
  filter(Formation %in% c('Temblor', NA, 'Etchegoin', 'San Joaquin',
                          'Monterey', 'Chanac', 'Tulare', 'Rio Bravo',
                          'Santa Margarita', 'Vedder', 'Jewett')) %>%
  ggplot() +
  geom_point(aes(x = 1/(Fe*1.79051e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05), 
                 colour = Formation), shape = 17) +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic2() +
  scale_colour_brewer(palette = "Paired", na.value="grey")

ggsave('Figures/Raw/Fe_PW.pdf', plot = Fe.PW,
       width = 4, height = 3, units = 'in')

Fe.CalGEM = 
  CalGEM.WSD.chem %>%
  filter(!is.na(Fe) | !is.na(Mn)) %>%
  #filter(Formation %in% c('Temblor', NA, 'Etchegoin', 'San Joaquin',
  #                        'Monterey', 'Chanac', 'Tulare', 'Rio Bravo',
  #                        'Santa Margarita', 'Vedder', 'Jewett')) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05)), shape = 17) +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic2() #+ scale_colour_brewer(palette = "Paired", na.value="grey")

```

mg As to mol *1.334935e-05
ug As to mol *1.334935e-08

### Arsenic


```{r As Fe/Mn mixing}

# USGS Rock chem
Fe.As.rock =
  USGS.NGDB.rock %>%
  filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05), 
                 colour = as.factor(xndryclass)), shape = 15,
             show.legend = FALSE) +
  scale_colour_brewer(palette = "Greys", direction=-1, na.value = "red") +
  scale_x_log10(limits = c(1e3, 1e7)) + 
  scale_y_log10(limits = c(1e-1, 2000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2() 
  

ggsave('Figures/Raw/Fe_As_Rock.pdf', plot = Fe.As.rock,
       width = 4, height = 3, units = 'in')


Fe.As.pond = 
  SJVPondsDat.Clean %>% filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-08), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-08))) +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 2000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2()
  
ggsave('Figures/Raw/Fe_As_Pond.pdf', plot = Fe.As.pond,
       width = 4, height = 3, units = 'in')
  
  
Fe.As.CalGEM = 
  CalGEM.WSD.chem %>%
  filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05)), shape = 17) +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 2000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2() 

ggsave('Figures/Raw/Fe_As_CalGEM.pdf', plot = Fe.As.CalGEM,
       width = 4, height = 3, units = 'in')

```


### Selenium


### DATA EXPLORATION

#### Arsenic

##### As Evaporative Effects

Is arsenic being evapoconcentrated?

```{r Generate plots for figure 5}

ClBr.As.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(!is.na(As)) %>% arrange(As) %>%
  ggplot() +
  geom_point(aes(x = Cl, y = Cl/Br, 
                 fill = cut_number(As, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(0, 30000) +
  labs(title = "", x = "Cl (ppm)", y = "Cl/Br") +
  theme_classic2()


# save plot
ggsave('Figures/Raw/ClBr_As.pdf', plot = ClBr.As.plt,
       width = 6, height = 3, units = 'in')

iso.As.plt =
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(!is.na(As)) %>% arrange(As) %>%
  ggplot() +
  geom_abline(intercept = 10, slope = 8) + # GMWL
  geom_abline(intercept = 3.82, slope = 7.74, colour ='red') + # LMWL
  geom_point(aes(x = Oxygen_18, y = Deuterium, 
                 fill = cut_number(As, n = 9, dig.lab = 6)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  xlim(-15, 15) +
  labs(title = "", x = "O18 (permil)", y = "H2 (permil)") +
  theme_classic2()


ggsave('Figures/Raw/iso_As.pdf', plot = iso.As.plt,
       width = 6, height = 3, units = 'in')

# The two plots above were combined in Adobe Illustrator

```

How does As relate to 2H? First determine what fields to look at

```{r get detections per field}

AsTopFive = 
  SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  group_by(Oil_Field) %>%
  dplyr::summarise(count = n()) %>% ungroup() %>%
  arrange(desc(count)) %>% 
  top_n(5) %>% 
  dplyr::mutate(across(Oil_Field, droplevels),
                across(Oil_Field, as.character)) %>%
  pull(Oil_Field)
  
```

How do As concentrations compare to 2H?

```{r Generate figure S}

As_H2.all.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(As)) %>%
  ggplot(aes(x = As, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(alpha = 0.4) +
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  xlim(1, 300) +
  theme_classic2()

ggsave('Figures/Raw/As_H2_all.pdf', plot = As_H2.all.plt,
       width = 3, height = 3, units = 'in')

As_H2.sub.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(As)) %>%
  filter(Oil_Field %in% c('BELGIAN ANTICLINE', 'ANTELOPE HILLS')) %>%
  dplyr::mutate(across(Oil_Field, droplevels)) %>%
  ggplot(aes(x = As, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point() + 
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  facet_wrap(~Oil_Field, scales = "free_y", ncol = 2) +
  xlim(0,150) +
  theme_classic2()

ggsave('Figures/Raw/As_H2_sub.pdf', plot = As_H2.sub.plt,
       width = 6, height = 3, units = 'in')

```

##### Look at potential redox interactions



```{r As Fe/Mn mixing}

# USGS Rock chem
Fe.As.rock =
  USGS.NGDB.rock %>%
  filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05), 
                 colour = as.factor(xndryclass)), shape = 15,
             show.legend = FALSE) +
  scale_colour_brewer(palette = "Greys", direction=-1,
                      na.value = "red") +
  scale_x_log10(limits = c(1e3, 1e7)) + 
  scale_y_log10(limits = c(1e-1, 2000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2() 
  

ggsave('Figures/Raw/Fe_As_Rock.pdf', plot = Fe.As.rock,
       width = 4, height = 3, units = 'in')


Fe.As.pond = 
  SJVPondsDat.Clean %>% filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-08), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-08))) +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 2000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2()
  
ggsave('Figures/Raw/Fe_As_Pond.pdf', plot = Fe.As.pond,
       width = 4, height = 3, units = 'in')
  
  
Fe.As.CalGEM = 
  CalGEM.WSD.chem %>%
  filter(!is.na(As)) %>%
  ggplot() +
  geom_point(aes(x = 1/(As*1.334935e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05)), shape = 17) +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 2000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2() 

ggsave('Figures/Raw/Fe_As_CalGEM.pdf', plot = Fe.As.CalGEM,
       width = 4, height = 3, units = 'in')

```


```{r Model As speciation}

# Create vector of species to include in PHREEQC solution
solution.cols = c("Oil_Field", "Temp_C", "pH", "Alkalinity_CaCO3", 
                  "As", "B", "Ba", "Br", "HCO3", "Ca", "Cl", "Fe", 
                  "K", "Mg", "Mn", "Na", "SO4", "Se", "Sr", 
                  "NH3", "NH4", "NO3", "TOC")

As.samps =
  SJVPondsDat.Clean %>%
  filter(Oil_Field %in% AsTopFive) %>%
  filter(!is.na(As)) %>%
  dplyr::select(any_of(solution.cols)) %>%
  group_by(Oil_Field) %>% 
  dplyr::summarise(across(everything(), ~median(.x, na.rm = TRUE)),
            n=n())

write_csv(As.samps, here('geochemical_data/PHREEQC','As_PHREEQCinput.csv')
          file = )

```




#### others


##### Selenium


```{r get detections per field}

SeTopFive = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Se)) %>%
  group_by(Oil_Field) %>%
  dplyr::summarise(count = n()) %>% ungroup() %>%
  arrange(desc(count)) %>% 
  top_n(5) %>% 
  dplyr::mutate(across(Oil_Field, droplevels),
                across(Oil_Field, as.character)) %>%
  pull(Oil_Field)
  
```

Is Se evapoconcentrated?

```{r Look at evaporation vs Se}

Se_H2.all.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(Se)) %>%
  ggplot(aes(x = Se, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(alpha = 0.4) +
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  #xlim(1, 300) +
  theme_classic2()

ggsave('Figures/Raw/Se_H2_all.pdf', plot = Se_H2.all.plt,
       width = 3, height = 3, units = 'in')

Se_H2.sub.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(Se)) %>%
  filter(Oil_Field %in% c('BELGIAN ANTICLINE', 'ANTELOPE HILLS')) %>%
  dplyr::mutate(across(Oil_Field, droplevels)) %>%
  ggplot(aes(x = Se, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point() + 
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  facet_wrap(~Oil_Field, scales = "free", ncol = 2) +
  theme_classic2()

ggsave('Figures/Raw/Se_H2_sub.pdf', plot = Se_H2.sub.plt,
       width = 6, height = 3, units = 'in')

```


Wahts driving Se dynamics?
```{r Is SE reacting with organic materials}

# interactions w/ org 
SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = SOC, y = Se)) +
  scale_y_log10() + 
  annotation_logticks(sides = "l") + theme_classic2()

SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = TOC, y = Se, 
                 fill = cut_number(Alkalinity_CaCO3, n = 4, dig.lab = 2)),
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_y_log10() + scale_x_log10() +
  annotation_logticks(sides = "lb") + 
  theme_classic2()

#ggsave('Figures/Raw/Se_orgx.pdf', plot = last_plot(),
 #      width = 6, height = 3, units = 'in')

SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = Alkalinity_CaCO3, y = Se),
             colour = 'black', shape = 21, stroke = 0.2) +
  #scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_y_log10() + scale_x_log10() +
  annotation_logticks(sides = "lb") + 
  theme_classic2()



SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot(aes(x = Alkalinity_CaCO3, 
             y = Se)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point() + 
  stat_regline_equation(label.y = 1, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  scale_y_log10() + scale_x_log10() +
  annotation_logticks(sides = "lb") + 
  theme_classic2()


ggsave('Figures/Raw/Se_Alk.pdf', plot = last_plot(),
       width = 3, height = 3, units = 'in')

# adsorption to clay mins
SJVPondsDat.Clean %>%
  ggplot() +
  geom_point(aes(x = CEC, y = Se)) +
  scale_y_log10() + 
  annotation_logticks(sides = "l") + theme_classic2()


SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = Fe, y = Se, 
                 fill = cut_interval(cf, n = 5, dig.lab = 2)), 
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_fill_brewer(palette = 'Spectral', direction = -1) +
  scale_y_log10() + scale_x_log10(limits = c(0.1, 100)) +
  annotation_logticks(sides = "l") + 
  theme_classic2()


#ggsave('Figures/Raw/Se_redoxFeMn.pdf', plot = last_plot(),
 #      width = 3, height = 3, units = 'in')

SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = SO4, y = Se),
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_y_log10() + scale_x_log10() +
  annotation_logticks(sides = "lb") + 
  theme_classic2()

#ggsave('Figures/Raw/Se_redoxS.pdf', plot = last_plot(),
#       width = 3, height = 3, units = 'in')


SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = Se, y = Oil_Grease, fill = Oil_Field),
             colour = 'black', shape = 21, stroke = 0.2) +
  scale_y_log10() + scale_x_log10() +
  annotation_logticks(sides = "lb") + 
  theme_classic2()


SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = B, y = Se, fill = Oil_Field), 
             colour = 'black', shape = 21, stroke = 0.2,
             show.legend = FALSE) +
  scale_x_log10() + scale_y_log10() +
  annotation_logticks(sides = "lb") +
  #scale_y_log10(limits=c(1e-2,200)) + 
  theme_classic2()

SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot() +
  geom_point(aes(x = Li, y = Se, fill = Oil_Field), 
             colour = 'black', shape = 21, stroke = 0.2,
             show.legend = FALSE) +
  scale_x_log10() + scale_y_log10() +
  annotation_logticks(sides = "lb") +
  #scale_y_log10(limits=c(1e-2,200)) + 
  theme_classic2()

```


```{r Model As speciation}

# Create vector of species to include in PHREEQC solution
solution.cols = c("Oil_Field", "Temp_C", "pH", "Alkalinity_CaCO3", 
                  "As", "B", "Ba", "Br", "HCO3", "Ca", "Cl", "Fe", 
                  "K", "Mg", "Mn", "Na", "SO4", "Se", "Sr", "TOC")

Se.samps =
  SJVPondsDat.Clean %>%
  filter(Oil_Field %in% SeTopFive) %>%
  filter(!is.na(Se)) %>%
  dplyr::select(any_of(solution.cols)) %>%
  group_by(Oil_Field) %>% 
  dplyr::summarise(across(everything(), ~median(.x, na.rm = TRUE)),
            n=n())

write_csv(Se.samps, file = 'Se_PHREEQCinput.csv')

```


```{r Se Fe/Mn mixing}

# USGS Rock chem
Fe.Se.rock =
  USGS.NGDB.rock %>%
  filter(!is.na(Se)) %>%
  ggplot() +
  geom_point(aes(x = 1/(Se*1.266464e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05), 
                 colour = as.factor(xndryclass)), shape = 15,
             show.legend = FALSE) +
  scale_colour_brewer(palette = "Greys", direction=-1,
                      na.value = "red") +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 1000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2() 
  

ggsave('Figures/Raw/Fe_Se_Rock.pdf', plot = Fe.Se.rock,
       width = 4, height = 3, units = 'in')


Fe.Se.pond = 
  SJVPondsDat.Clean %>% filter(!is.na(Se)) %>%
  ggplot() +
  geom_point(aes(x = 1/(Se*1.266464e-08), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-08))) +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 1000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2()
  
ggsave('Figures/Raw/Fe_Se_Pond.pdf', plot = Fe.Se.pond,
       width = 4, height = 3, units = 'in')
  
  
Fe.Se.CalGEM = 
  CalGEM.WSD.chem %>%
  filter(!is.na(Se)) %>%
  ggplot() +
  geom_point(aes(x = 1/(Se*1.266464e-05), 
                 y = (Fe*1.79051e-05)/(Mn*1.820167e-05)), shape = 17) +
  scale_x_log10(limits = c(1e3, 1e7)) +  
  scale_y_log10(limits = c(1e-1, 1000)) +
  annotation_logticks(sides = 'lb') +
  theme_classic2() 

ggsave('Figures/Raw/Fe_Se_CalGEM.pdf', plot = Fe.Se.CalGEM,
       width = 4, height = 3, units = 'in')

```


### Look at Charge Balance Errors

How many Charge Balance Errors (CBE) are greater than 20%?
```{r Count CBEs}

print(paste("Number of CBEs greater than 10%:", 
            SJVPondsDat.Clean %>% 
              filter(!is.na(Ca) & !is.na(Cl)) %>%
              filter(abs(CBE) >= 10) %>% count()))

print(paste("Number of CBEs greater than 20%:", 
            SJVPondsDat.Clean %>% 
              filter(!is.na(Ca) & !is.na(Cl)) %>%
              filter(abs(CBE) >= 20) %>% count()))
```


```{r Generate Figure S2, message=FALSE, warning=FALSE}

CBE.sigma = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Ca) & !is.na(Cl)) %>%
  summarise(sigma = sd(CBE)) %>%
  pull(sigma)

CBE.Hist = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Ca) & !is.na(Cl)) %>%
  ggplot(aes(x=CBE)) + 
  geom_histogram(colour = 'black', binwidth = 5) +
  geom_vline(xintercept=2*CBE.sigma) + 
  geom_vline(xintercept=-2*CBE.sigma)+
  labs(title = "", x = "Charge Balance Error", 
       y = "Count") +
  #theme(legend.position = "none") +
  theme_classic2()

CBE.Hist

ggsave("CBE.pdf", plot = CBE.Hist, width = 4, 
       height = 2.5, units = "in", limitsize = TRUE)
```


### Generate Summary Statistics




#### Summarise data on a per facility basis

``` {r}  
  pivot_longer(cols = everything(),
               names_to = "Analyte",
               values_to = "Concentration") %>%
  group_by(Analyte) %>%
  # Generate summary statistics of analytes
  summarise(detects = sum(!is.na(Concentration)),
            Min = min(Concentration, na.rm = TRUE),
            Med = median(Concentration, na.rm = TRUE),
            Max = max(Concentration, na.rm = TRUE),
            `5th` = quantile(Concentration, probs = 0.05, na.rm = TRUE),
            `25th` = quantile(Concentration, probs = 0.25, na.rm = TRUE),
            `75th` = quantile(Concentration, probs = 0.75, na.rm = TRUE),
            `95th` = quantile(Concentration, probs = 0.95, na.rm = TRUE)) %>%
  arrange(match(Analyte, summ.analytes)) %>%
  # add in counts of non detections for each analyte
  add_column(NDs = nonDetects$nondetects, .after = "detects") %>%
  # round to 3 sigfigs
  mutate(across(c(4:10), ~signif(.x, digits = 3))) %>%
  mutate(`Detections : NDs` = paste(as.character(detects),
                                    as.character(NDs), sep = ":"),
         .after = Analyte) %>%
  select(!c(detects, NDs))
```


## Random Forest

### Explanatory variables

Before building models put together a vector of all explanatory variables:

Tulare Basin Plan Analytes
- SC:       Specific Conductance                                (Î¼S/cm)
- TDS:      Total Dissolved Solids                              (mg/L)
- Cl:       Chloride                                            (mg/L)
- B:        Boron                                               (mg/L)

Spatial Variables

  SoilGRIDs
- BD		    Bulk density of fine earth fraction                 (g/cm3)
- CEC		    Cation Exchange Capacity                            (cmol(c)/kg)
- cf		    Volumetric % fragments > 2 mm                       (%)
- clay		  Mass % clay particles (< 0.002 mm)                  (%)
- pH_soil	  Soil pH                                             (pH)
- sand		  Mass % sand particles (> 0.05 mm)		                (%)
- silt		  Mass % silt particles (â¥ 0.002 mm & â¤ 0.05 mm)	    (%)
- SOC		    Soil organic carbon in fine earth fraction	        (g/kg)
- MAEt	    Mean Annual Reference Evapotranspiration	          (mm/yr)
- MAP       Mean Annual Precipitation			                      (mm/yr)
- AxisSide  Location of sample in relation to valley axis

  STATSGO2
- slope_wa  Slope gradient, weighted average                    (%)
- aws_0.150 Available water storage, 0-150 cm                   (cm)
- hydrgrp   Hydrologic group                                

  USGS Geochem
- C_As      Soil C horizon As content                           (mg/kg)
- C_Fe		  Soil C horizon Fe content                           (%)
- C_Mn		  Soil C horizon Mn content                           (mg/kg)
- C_Se		  Soil C horizon Se content                           (mg/kg)

  Groundwater
- WLBLS     Depth of interpolated avg water below land surface  (m)  


```{r Create vector of predictor variables}

# create vector of spatial variables
spat.vars = 
  colnames(SJV.spatial.vars)[-str_detect(colnames(SJV.spatial.vars), 'Int_ID')] 
# create vector of Tulare Basin Plan analytes
Tulare.vars = c('Specific_Conductance', 'TDS', 'Cl', 'B') 

predict.vars = 
  c('Oil_Field', Tulare.vars) %>%
  c(.,spat.vars)

```


### Clean Data for Model Building

```{r Create simplified data for model creation}

# Arsenic
As.rF.input.raw =
  SJVPondsDat.Clean %>%
  filter(case_when(!is.na(Ca) ~ CBE_flag == 'N',
                 TRUE ~ CBE_flag == 'N' | CBE_flag == 'Y')) %>%
  dplyr::select(any_of(c('As', predict.vars))) %>%
  # remove missing values
  drop_na(As) %>%
  #dplyr::mutate(across(Oil_Field, droplevels)) %>%
  as.data.frame(.)


# Selenium
Se.rF.input.raw =
  SJVPondsDat.Clean %>%
  filter(case_when(!is.na(Ca) ~ CBE_flag == 'N',
                 TRUE ~ CBE_flag == 'N' | CBE_flag == 'Y')) %>%
  dplyr::select(any_of(c('Se', predict.vars))) %>%
  # remove missing values
  drop_na(Se) %>%
  #dplyr::mutate(across(Oil_Field, droplevels)) %>%
  as.data.frame(.)

```

#### Check for Correlations

```{r Arsenic correlations}

As.raw.cor = 
  As.rF.input.raw %>%
  dplyr::select(-where(is.factor))

As.cor = rcorr(as.matrix(As.raw.cor), type = 'spearman')
As.cor.r = As.cor$r
As.cor.p = As.cor$P

findCorrelation(As.cor.r, cutoff = 0.85, verbose = TRUE, names = TRUE)

```


```{r Generate Figure S3}

# Save corplot as pdf
pdf(file = 'Figures/Raw/AsCorr.pdf')
  corrplot(As.cor.r, method = 'number', diag = FALSE, 
           type ='upper', tl.cex = 0.8, number.cex = 0.6, 
           number.digits = 2)
dev.off()


# Save corplot pvals as pdf
pdf(file = 'Figures/Raw/AsCorrPval.pdf')
  corrplot(As.cor.r, p.mat = As.cor.p, method = 'color', diag = FALSE, 
           type = 'upper', sig.level = c(0.001, 0.01, 0.05), 
           pch.cex = 0.9, insig = 'label_sig', pch.col = 'grey20')
dev.off()

```


```{r Selenium correlations}
Se.raw.cor = 
  Se.rF.input.raw %>%
  dplyr::select(-where(is.factor)) 

Se.cor = rcorr(as.matrix(Se.raw.cor), type = 'spearman')
Se.cor.r = Se.cor$r
Se.cor.p = Se.cor$P
 
findCorrelation(Se.cor.r, cutoff=0.85, verbose = TRUE, names = TRUE)

```


```{r Generate Figure S4}

# Save corrplot as pdf
pdf(file = 'Figures/Raw/SeCorr.pdf')
  corrplot(Se.cor.r, method = 'number', diag = FALSE, 
           type ='upper', tl.cex = 0.8, number.cex = 0.6, 
           number.digits = 2)
dev.off()

# Save corplot pvals as pdf
pdf(file = 'Figures/Raw/SeCorrPval.pdf')
  corrplot(Se.cor.r, p.mat = Se.cor.p, method = 'color', diag = FALSE, 
           type = 'upper', sig.level = c(0.001, 0.01, 0.05), 
           pch.cex = 0.9, insig = 'label_sig', pch.col = 'grey20')
dev.off()

```



#### Remove Correlated Variables/Create input data


```{r Identify NA rows in As input data}

As.NAs =
  As.rF.input.raw %>% 
  filter(is.na(Cl) | is.na(B)) %>% 
  pull(Oil_Field) %>% as.character(.)

# Calculate median value per field
As.meds = 
  SJVPondsDat.Clean %>% 
  group_by(Oil_Field) %>% 
  summarise(median(Cl, na.rm = TRUE),
            median(B, na.rm = TRUE)) %>%
  filter(Oil_Field %in% As.NAs)

As.meds

```



```{r Determine formula to impute missing TDS from EC}

# Determine relationship of EC and TDS to impute missing TDS values
TDS_EC.plt = 
  SJVPondsDat.Clean %>% 
  ggplot(aes(x= log10(Specific_Conductance), y = log10(TDS))) + 
  geom_smooth(method = 'lm', colour = 'black') +
  geom_point(colour = 'dodgerblue4', alpha = 0.4) + theme_classic2()

ggsave('Figures/Raw/TDS_EC.pdf', plot = TDS_EC.plt,
       width = 3.5, height = 3.5, units = 'in')

# fit linear model to data
fit = 
  lm(log10(TDS) ~ log10(Specific_Conductance), data = SJVPondsDat.Clean)

summary(fit)

```


```{r Drop correlated vars, trans vars}

# Create vector of predictors to drop
predicts_to_drop = c('clay', 'sand', 'Specific_Conductance')

# create vector of variables to log10 transform
log_trans_vars = c('As', 'Se', 'Cl', 'B')

## Arsenic
As.rF.input = 
  As.rF.input.raw %>% 
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(Cl, ~if_else(is.na(.x), 87, .x)), # impute missing Cl
    across(B, ~case_when(is.na(.x) & Oil_Field == 'KERN FRONT' ~ 0.92,
                         is.na(.x) & Oil_Field == 'DEER CREEK' ~ 0.68,
                         TRUE ~ .x)), # impute missing B
    across(any_of(log_trans_vars), log10)) %>%
  dplyr::select(-any_of(c(predicts_to_drop))) # drop correlated vars


## Selenium  
Se.rF.input = 
  Se.rF.input.raw %>% 
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                  (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10)) %>%
  dplyr::select(-any_of(c(predicts_to_drop))) # drop correlated vars

```


#### Visualize Distributions of Transformed Data

```{r Generate Figure S6, warning=FALSE}

As.RFR.dens.plt = 
  As.rF.input %>% 
  dplyr::select(-where(is.factor)) %>% 
  pivot_longer(cols = everything(), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x=val)) + geom_density() + 
  facet_wrap(~var, scales='free') + 
  theme_classic2()

```


```{r Generate Figure S7, warning=FALSE}

Se.RFR.dens.plt = 
  Se.rF.input %>% 
  dplyr::select(-where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x=val)) + geom_density() + 
  facet_wrap(~var, scales='free') + 
  theme_classic2()

```


### Random Forests

#### Train/Test Splits

For each trace, the train data set (used to build the model) will consist of 80% of the samples with a detectable amount of that analyte, and the test data set (used to validate the model) will be the remaining 20% of the samples with detectable concentrations.

```{r Caret test train splits}

set.seed(429)

## Arsenic log10 transformed 
As.train = createDataPartition(y = As.rF.input$As, p = 0.80, list = FALSE)

As.tr.log = As.rF.input[As.train,] 
As.tst.log = As.rF.input[-As.train,]


## Selenium log10 transformed
Se.train = createDataPartition(y = Se.rF.input$Se, p = 0.80, list = FALSE)

Se.tr.log = Se.rF.input[Se.train,]
Se.tst.log = Se.rF.input[-Se.train,]

```


#### Create Model Defaults

```{r Set model controls}

# Same for all
control = 
  trainControl(method = 'repeatedcv', 
               number = 10, # 10 folds
               repeats = 5, # 5 repeated 10-fold CV
               selectionFunction = 'tolerance') # select best model considering
                                      # the % change in RMSE as mtry increases

tunegrid = expand.grid(mtry = 1:21)

```


```{r}

ctrl = 
  trainControl(method = 'repeatedcv', 
               number = 10, # 10 folds
               repeats = 5, # 5 repeated 10-fold CV
               selectionFunction = 'oneSE') # select best model considering
                                      # the % change in RMSE as mtry increases

```


#### Build RFR Models for Untransformed Data
```{r Caret run random forests}

# run Random Forests
As.rF = train(As~., data = As.tr, method = 'rf', 
           trControl = control, metric = 'RMSE', 
           tuneGrid = tunegrid, na.action = na.exclude)

Se.rF = train(Se~., data = Se.tr, method = 'rf', 
           trControl = control, metric = 'RMSE', 
           tuneGrid = tunegrid, na.action = na.exclude)

```


```{r Caret RMSE plots, message=FALSE}

# Create RMSE plots for each trace

As.RMSE.plt =
  As.rF$results %>%
  ggplot(aes(x = mtry, y = RMSE)) +
  geom_line(linetype="dashed", colour = "grey40") +
  geom_errorbar(aes(ymin = RMSE-RMSESD,
                    ymax = RMSE+RMSESD), 
                width = 1, color = "grey") +
  geom_point(size = 2) +
  labs(title = "Arsenic", x = "# of variables", 
       y = "RMSE") +
  theme(legend.position = "none") +
  theme_classic2()

Se.RMSE.plt =
  Se.rF$results %>%
  ggplot(aes(x = mtry, y = RMSE)) +
  geom_line(linetype="dashed", colour = "grey40") +
  geom_errorbar(aes(ymin = RMSE-RMSESD,
                    ymax = RMSE+RMSESD), 
                width = 1, color = "grey") +
  geom_point(size = 2) +
  labs(title = "Selenium", x = "# of variables", 
       y = "RMSE") +
  theme(legend.position = "none") +
  theme_classic2()

#create list of plots
RMSE.plots = c('As.RMSE.plt', 'Se.RMSE.plt')

RMSE.plt.lst = list()

for (i in RMSE.plots) {RMSE.plt.lst[[i]] = get(i)}
  
lapply(names(RMSE.plt.lst), function(x) {
  ggsave(filename = paste0('Figures/Raw/', paste0(x,'.pdf')), 
         plot = RMSE.plt.lst[[x]], units = 'in',
         width = 5, height = 2.5, limitsize = TRUE)})

```


```{r Compare predictions to observations}
# use rf to predict test set
As.pred = predict(As.rF, As.tst, na.action = na.exclude)
Se.pred = predict(Se.rF, Se.tst, na.action = na.exclude)

# remove any NAs from the data to eliminate errors
As.na = As.tst %>% drop_na()
Se.na = Se.tst %>% drop_na()

# create a data frame of various errors for plotting
As.err = 
  postResample(pred = As.pred, obs = As.na$As) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab') %>%
  rename(., err = `.`) %>%
  mutate(across(2, ~signif(.x, digits = 3)))

Se.err = 
  postResample(pred = Se.pred, obs = Se.na$Se) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab') %>%
  rename(., err = `.`) %>%
  mutate(across(2, ~signif(.x, digits = 3)))

```

```{r Look at errors untrans model}

As.err
Se.err

```


```{r Plot observed values vs. predicted, message=TRUE}

# plot predictions vs. observations
As.comp.plt =
  ggplot() +
  geom_point(aes(x = As.pred, y = As.na$As)) + 
  geom_abline(intercept = 0, linetype = 2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

Se.comp.plt =
  ggplot() +
  geom_point(aes(x = Se.pred, y = Se.na$Se)) + 
  geom_abline(intercept = 0, linetype = 2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

Zn.comp.plt =
  ggplot() +
  geom_point(aes(x = Zn.pred, y = Zn.na$Zn)) + 
  geom_abline(intercept = 0, linetype = 2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

Ni.comp.plt =
  ggplot() +
  geom_point(aes(x = Ni.pred, y = Ni.na$Ni)) + 
  geom_abline(intercept = 0, linetype = 2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

Cu.comp.plt =
  ggplot() +
  geom_point(aes(x = Cu.pred, y = Cu.na$Cu)) + 
  geom_abline(intercept = 0, linetype = 2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

Mo.comp.plt =
  ggplot() +
  geom_point(aes(x = Mo.pred, y = Mo.na$Mo)) + 
  geom_abline(intercept = 0, linetype = 2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

Hg.comp.plt =
  ggplot() +
  geom_point(aes(x = Hg.pred, y = Hg.na$Hg)) + 
  geom_abline(intercept = 0, linetype = 2) +
  ylim(0,2) +
  labs(title = '',
       y = 'Measured Concentration (Î¼g/L)',
       x = 'Predicted Concentration (Î¼g/L)') +
  theme_classic2()

# create list of plots
comp.plots = 
  c('As.comp.plt', 'Se.comp.plt', 'Zn.comp.plt', 'Ni.comp.plt',
    'Cu.comp.plt', 'Mo.comp.plt', 'Hg.comp.plt')

comp.plt.lst = list()

for (i in comp.plots) {comp.plt.lst[[i]] = get(i)}
  
lapply(names(comp.plt.lst), function(x) {
  ggsave(filename = paste0('Figures/Raw/', paste0(x,'.pdf')), 
         plot = comp.plt.lst[[x]], units = 'in',
         width = 2.25, height = 2.25, limitsize = TRUE)})

```


```{r Compare predictions against nondetects}
As.ND = 
  SJVPondsDat.ND %>%
  filter(Detect_Limit == 'MDL') %>%
  filter(!is.na(As)) %>%
  dplyr::select(any_of(c('As',predict.vars))) %>%
  mutate(across(TDS:B, as.numeric)) %>%
  separate(As, into = c(NA, 'As'), 
             sep = '<', remove = TRUE, convert = TRUE) %>%
  # remove missing values
  drop_na(As) %>%
  as.data.frame(.)

As.pred.ND = predict(As.rF, As.ND, na.action = na.exclude)

As.ND.na = As.ND %>% drop_na()


# create a data frame of various errors for plotting
As.err = 
  postResample(pred = As.pred, obs = As.na$As) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab') %>%
  rename(., err = `.`) %>%
  mutate(across(2, ~signif(.x, digits = 3)))
```


#### Build RFR Models for Log10 Transformed Data
```{r Caret run random forests log 10}

# run Random Forests on log 10 transformed data
As.rF.log = 
  caret::train(As~., data = As.tr.log, method = 'rf', 
               trControl = control, metric = 'RMSE', 
               tuneGrid = tunegrid, na.action = na.omit)

Se.rF.log = 
  caret::train(Se~., data = Se.tr.log, method = 'rf', 
               trControl = control, metric = 'RMSE', 
               tuneGrid = tunegrid, na.action = na.omit)


Hg.rF.log = 
  caret::train(Hg~., data = Hg.tr.log, method = 'rf', 
               trControl = control, metric = 'RMSE', 
               tuneGrid = tunegrid, na.action = na.omit)
```


##### Visualize RSME for Log10 Tranformed Model

```{r Caret log10 RMSE plots, message=FALSE}

# Create RMSE plots for each trace

As.log.RMSE.plt =
  As.rF.log$results %>%
  ggplot(aes(x = mtry, y = RMSE)) +
  geom_line(linetype="dashed", colour = "grey40") +
  geom_errorbar(aes(ymin = RMSE-RMSESD,
                    ymax = RMSE+RMSESD), 
                width = 0.4, color = "grey") +
  geom_point(size = 2) +
  labs(title = "Arsenic", x = "# of variables", 
       y = "RMSE") +
  theme(legend.position = "none") +
  theme_classic2()

Se.log.RMSE.plt =
  Se.rF.log$results %>%
  ggplot(aes(x = mtry, y = RMSE)) +
  geom_line(linetype="dashed", colour = "grey40") +
  geom_errorbar(aes(ymin = RMSE-RMSESD,
                    ymax = RMSE+RMSESD), 
                width = 0.4, color = "grey") +
  geom_point(size = 2) +
  labs(title = "Selenium", x = "# of variables", 
       y = "RMSE") +
  theme(legend.position = "none") +
  theme_classic2()

#Hg.log.RMSE.plt =
#  Hg.rF.log$results %>%
#  ggplot(aes(x = mtry, y = RMSE)) +
#  geom_line(linetype="dashed", colour = "grey40") +
#  geom_errorbar(aes(ymin = RMSE-RMSESD,
#                    ymax = RMSE+RMSESD), 
#                width = 0.4, color = "grey") +
#  geom_point(size = 2) +
#  labs(title = "Mercury", x = "# of variables", 
#       y = "RMSE") +
#  theme(legend.position = "none") +
#  theme_classic2()

#create list of plots
RMSE.log.plots = 
  c('As.log.RMSE.plt', 'Se.log.RMSE.plt')

RMSE.log.plt.lst = list()

for (i in RMSE.log.plots) {RMSE.log.plt.lst[[i]] = get(i)}
  
lapply(names(RMSE.log.plt.lst), function(x) {
  ggsave(filename = paste0('Figures/Raw/', paste0(x,'.pdf')), 
         plot = RMSE.log.plt.lst[[x]], units = 'in',
         width = 5, height = 2.5, limitsize = TRUE)})

```


##### Visualize Variable Importance for Log10 Tranformed Model

```{r As var importance}

As.y.imp = As.tr.log %>% drop_na()

As.pred.imp = 
  Predictor$new(As.rF.log,
                data = As.y.imp[which(names(As.y.imp) != 'As')],
                y = As.y.imp$As)

As.imp = FeatureImp$new(As.pred.imp, loss = 'rmse')

As.imp.plt = plot(As.imp) + theme_classic2()

As.imp.plt

ggsave('Figures/Raw/ImportancePlots/As_imp.pdf', plot = As.imp.plt,
       height = 4, width = 4, units = 'in')

```


```{r Se var importance}

Se.y.imp = Se.tr.log %>% drop_na()

Se.pred.imp = 
  Predictor$new(Se.rF.log,
                data = Se.y.imp[which(names(Se.y.imp) != 'Se')],
                y = Se.y.imp$Se)

Se.imp = FeatureImp$new(Se.pred.imp, loss = 'rmse')

Se.imp.plt = plot(Se.imp) + theme_classic2()

Se.imp.plt

ggsave('Figures/Raw/ImportancePlots/Se_imp.pdf', plot = Se.imp.plt,
       height = 4, width = 4, units = 'in')

```


```{r Hg var importance}

Hg.y.imp = Hg.tr.log %>% drop_na()

Hg.pred.imp = 
  Predictor$new(Hg.rF.log,
                data = Hg.y.imp[which(names(Hg.y.imp) != 'Hg')],
                y = Hg.y.imp$Hg)

Hg.imp = FeatureImp$new(Hg.pred.imp, loss = 'rmse')

Hg.imp.plt = plot(Hg.imp) + theme_classic2()

Hg.imp.plt

ggsave('Figures/Raw/Hg.imp.plt.pdf', plot = Hg.imp.plt,
       height = 4, width = 4, units = 'in')

```

##### Visualize Regional Heterogeniety

```{r Arsenic Oil Field pdp}

As.field.pdp = 
  FeatureEffect$new(As.pred.imp, feature = 'Oil_Field', method = 'pdp')

As.field.plt = plot(As.field.pdp) + theme_classic2()

ggsave('Figures/Raw/ImportancePlots/As_field.pdf', plot = As.field.plt,
       height = 4, width = 7, units = 'in')

sd(As.field.pdp$results$.value, na.rm = TRUE)
mean(As.field.pdp$results$.value, na.rm = TRUE)

# Stats
As.field.wilcox.in = 
  As.rF.input.raw %>% 
  group_by(Oil_Field) %>% 
  filter(n() >= 5) %>%
  mutate(across(Oil_Field, droplevels))

As.field.wilcox = 
  pairwise.wilcox.test(As.field.wilcox.in$As, As.field.wilcox.in$Oil_Field,
                     p.adjust.method = 'none', exact = TRUE)

As.field.wil.p = 
  as.data.frame(As.field.wilcox$p.value) %>%
  mutate(across(everything(), ~signif(.x, digits = 3, na.rm = TRUE)))

write_csv(As.field.wil.p, file = 'AsFielWilPvals.csv')

As.field.box = 
  As.rF.input.raw %>%
  ggplot(aes(x = Oil_Field, y = As)) + geom_boxplot() + 
  #stat_pvalue_manual() +
  theme_classic2()

ggsave('Figures/Raw/ImportancePlots/As_field_box.pdf', plot = As.field.box,
       height = 4, width = 6, units = 'in')

```


```{r Selenium Oil Field pdp}

Se.field.pdp = 
  FeatureEffect$new(Se.pred.imp, feature = 'Oil_Field', method = 'pdp')

Se.field.plt = plot(Se.field.pdp) + theme_classic2()

ggsave('Figures/Raw/ImportancePlots/Se_field.pdf', plot = Se.field.plt,
       height = 4, width = 7, units = 'in')

mean(Se.field.pdp$results$.value, na.rm = TRUE)
sd(Se.field.pdp$results$.value, na.rm = TRUE)

# Stats
Se.field.wilcox.in = 
  Se.rF.input.raw %>% 
  group_by(Oil_Field) %>% 
  filter(n() >= 5) %>%
  mutate(across(Oil_Field, droplevels))

Se.field.wilcox = 
  pairwise.wilcox.test(Se.field.wilcox.in$Se, Se.field.wilcox.in$Oil_Field,
                       p.adjust.method = 'none', exact = TRUE)

Se.field.wil.p = 
  as.data.frame(Se.field.wilcox$p.value) %>%
  mutate(across(everything(), ~signif(.x, digits = 3, na.rm = TRUE)))

write_csv(Se.field.wil.p, file = 'SeFielWilPvals.csv')

Se.field.box = 
  Se.rF.input.raw %>%
  ggplot() + geom_boxplot(aes(x = Oil_Field, y = Se)) + 
  #stat_pvalue_manual()
  theme_classic2()

ggsave('Figures/Raw/ImportancePlots/Se_field_box.pdf', plot = Se.field.box,
       height = 4, width = 6, units = 'in')

```




##### Visualize Variable Interactions

##### Arsenic Interactions

Look at PDP for all predictors

```{r All As pdps, message=FALSE, warning=FALSE}

As.pdps = FeatureEffects$new(As.pred.imp, method = 'pdp')

As.pdp.plt = 
  ldply(As.pdps$results, data.frame) %>%
  filter(.feature != 'Oil_Field') %>%
  ggplot() + geom_line(aes(x = as.numeric(.borders), y = .value)) +
  facet_wrap(~.feature, scales = 'free_x') + 
  theme_classic2()

As.pdp.plt

ggsave('Figures/Raw/PartialDep/As_all.pdf', plot = As.pdp.plt, 
       height = 4, width = 6.5, units = 'in')

```


```{r Arsenic pdps}

# Cl vs. B
As.pdp.Cl.B = 
  pdp::partial(As.rF.log, pred.var = c('Cl', 'B'), chull = TRUE)

As.pdp.Cl.B.plt = 
  autoplot(As.pdp.Cl.B, contour = TRUE, 
           legend.title = "log10(As)(ug/L)") + 
  theme_classic2()

As.pdp.Cl.B.plt

ggsave('Figures/Raw/PartialDep/As_ClvB.pdf', plot = As.pdp.Cl.B.plt,
       height = 4, width = 6, units = 'in')


# Cl vs. MAP
As.pdp.Cl.MAP = 
  pdp::partial(As.rF.log, pred.var = c('Cl', 'MAP'), chull = TRUE)

As.pdp.Cl.MAP.plt = 
  ggplot(As.pdp.Cl.MAP, 
         aes(x = Cl, y = MAP, z = yhat)) +
  geom_contour_filled(binwidth = 0.075, colour = 'black') + 
  scale_fill_brewer(palette = 'Blues') + 
  theme_classic2()

As.pdp.Cl.MAP.plt

ggsave('Figures/Raw/PartialDep/As_ClvMAP.pdf', plot = As.pdp.Cl.MAP.plt,
       height = 4, width = 6, units = 'in')


# MAP vs. soil pH
As.pdp.MAP.pH = 
  pdp::partial(As.rF.log, pred.var = c('MAP', 'pH_soil'), chull = TRUE)

As.pdp.MAP.pH.plt = 
  autoplot(As.pdp.MAP.pH, contour = TRUE, 
           legend.title = "log10(As)(ug/L)") + 
  theme_classic2()

As.pdp.MAP.pH.plt

ggsave('Figures/Raw/PartialDep/As_MAPvPH.pdf', plot = As.pdp.MAP.pH.plt,
       height = 4, width = 6, units = 'in')

# MAP vs. silt
As.pdp.MAP.silt = 
  pdp::partial(As.rF.log, pred.var = c('MAP', 'silt'), chull = TRUE)

As.pdp.MAP.silt.plt = 
  autoplot(As.pdp.MAP.silt, contour = TRUE, 
           legend.title = "log10(As)(ug/L)") + 
  scale_colour_brewer(palette = "Spectral") +
  theme_classic2()

As.pdp.MAP.silt.plt

ggsave('Figures/Raw/PartialDep/As_MAPvSilt.pdf', plot = As.pdp.MAP.silt.plt,
       height = 4, width = 6, units = 'in')


# soil pH vs. SOC
As.pdp.pH.SOC = 
  pdp::partial(As.rF.log, pred.var = c('pH_soil', 'SOC'), chull = TRUE)

As.pdp.pH.SOC.plt = 
  ggplot(As.pdp.pH.SOC, 
         aes(x = pH_soil, y = SOC, z = yhat)) +
  #geom_tile() + 
  geom_contour_filled(binwidth = 0.015,
               colour = 'black') + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) + 
  theme_classic2()

As.pdp.pH.SOC.plt

ggsave('Figures/Raw/PartialDep/As_PHvSOC.pdf', plot = As.pdp.pH.SOC.plt,
       height = 4, width = 6, units = 'in')


```


```{r Se pdps}

# Cl vs. B
Se.pdp.Cl.B = 
  pdp::partial(Se.rF.log, pred.var = c('Cl', 'B'), chull = TRUE)

Se.pdp.Cl.B.plt = 
  autoplot(Se.pdp.Cl.B, contour = TRUE, 
           legend.title = "log10(Se)(ug/L)") + 
  theme_classic2()

As.pdp.Cl.B.plt

ggsave('Figures/Raw/PartialDep/As_ClvB.pdf', plot = As.pdp.Cl.B.plt,
       height = 4, width = 6, units = 'in')


# Cl vs. MAP
Se.pdp.Cl.MAP = 
  pdp::partial(Se.rF.log, pred.var = c('Cl', 'MAP'), chull = TRUE)

Se.pdp.Cl.MAP.plt = 
  ggplot(Se.pdp.Cl.MAP, 
         aes(x = Cl, y = MAP, z = yhat)) +
  geom_contour_filled(binwidth = 0.05,
               colour = 'black') + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) + 
  theme_classic2()

Se.pdp.Cl.MAP.plt

ggsave('Figures/Raw/PartialDep/Se_ClvMAP.pdf', plot = Se.pdp.Cl.MAP.plt,
       height = 4, width = 6, units = 'in')


# TDS vs. soil pH
Se.pdp.TDS.pH = 
  pdp::partial(Se.rF.log, pred.var = c('TDS', 'pH_soil'), chull = TRUE)

Se.pdp.TDS.pH.plt = 
  ggplot(Se.pdp.TDS.pH, 
         aes(x = TDS, y = pH_soil, z = yhat)) +
  geom_contour_filled(binwidth = 0.05,
               colour = 'black') + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) + 
  theme_classic2()

Se.pdp.TDS.pH.plt

ggsave('Figures/Raw/PartialDep/Se_TDSvPH.pdf', plot = Se.pdp.TDS.pH.plt,
       height = 4, width = 6, units = 'in')

# TDS vs. MAP
# TDS vs. soil pH
Se.pdp.TDS.MAP = 
  pdp::partial(Se.rF.log, pred.var = c('TDS', 'MAP'), chull = TRUE)

Se.pdp.TDS.MAP.plt = 
  ggplot(Se.pdp.TDS.MAP, 
         aes(x = TDS, y = MAP, z = yhat)) +
  geom_contour_filled(binwidth = 0.05,
               colour = 'black') + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) + 
  theme_classic2()

Se.pdp.TDS.MAP.plt

ggsave('Figures/Raw/PartialDep/Se_TDSvMAP.pdf', plot = Se.pdp.TDS.MAP.plt,
       height = 4, width = 6, units = 'in')


# soil pH vs. SOC
As.pdp.pH.SOC = 
  pdp::partial(As.rF.log, pred.var = c('pH_soil', 'SOC'), chull = TRUE)

As.pdp.pH.SOC.plt = 
  ggplot(As.pdp.pH.SOC, 
         aes(x = pH_soil, y = SOC, z = yhat)) +
  #geom_tile() + 
  geom_contour_filled(binwidth = 0.015,
               colour = 'black') + 
  scale_fill_brewer(palette = 'Spectral', direction = -1) + 
  theme_classic2()

As.pdp.pH.SOC.plt

ggsave('Figures/Raw/PartialDep/As_PHvSOC.pdf', plot = As.pdp.pH.SOC.plt,
       height = 4, width = 6, units = 'in')

```




##### Plot Model Predictions vs. Observations for Log10 Tranformed Model

```{r Compare log10 predictions to observations}

# use rf to predict test set
As.log.pred = predict(As.rF.log, As.tst.log, na.action = na.omit)
Se.log.pred = predict(Se.rF.log, Se.tst.log, na.action = na.omit)

# create a data frame of various errors for plotting
As.log.err = 
  postResample(pred = As.log.pred, obs = As.tst.log$As) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab') %>%
  dplyr::rename(., err = `.`) %>%
  dplyr::mutate(across(2, ~signif(.x, digits = 3)))

Se.log.err = 
  postResample(pred = Se.log.pred, obs = Se.tst.log$Se) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab')  %>%
  dplyr::rename(., err = `.`) %>%
  dplyr::mutate(across(2, ~signif(.x, digits = 3)))

```

```{r View log10 model errors}

As.log.err
Se.log.err

```


#### Plot Predictions vs. Observations

```{r As predict vs obs}
As.preds_vs_obs.plt =
  ggplot() + 
  geom_abline(intercept = 0, linetype = 2) +
  geom_point(aes(x = As.log.pred, y = As.tst.log$As),
             alpha = 0.4) + 
  xlim(0,3) + ylim(0,3) +
  labs(x = 'Predicted log10(As) (Âµg/L)', 
       y = 'Observed log10(As) (Âµg/L)') +
  theme_classic2()

As.preds_vs_obs.plt


ggsave('Figures/Raw/As.pred.obs.pdf', plot = As.preds_vs_obs.plt,
       height = 4.5, width = 4.5, units = 'in')

```


```{r Se predict vs obs}
Se.preds_vs_obs.plt =
  ggplot() + 
  geom_abline(intercept = 0, linetype = 2) +
  geom_point(aes(x = Se.log.pred, y = Se.tst.log$Se),
             alpha = 0.4) + 
  xlim(0,3) + ylim(0,3) +
  labs(x = 'Predicted log10(Se) (Âµg/L)', 
       y = 'Observed log10(Se) (Âµg/L)') +
  theme_classic2()

Se.preds_vs_obs.plt

ggsave('Figures/Raw/Se.pred.obs.pdf', plot = Se.preds_vs_obs.plt,
       height = 4.5, width = 4.5, units = 'in')

```


#### Predict missing data

```{r Create sample coords for mapping}

# Create df of sample coords
SJV.coords = 
  st_read('~/gis/SJVCompDat/SJVCompSamps.shp') %>%
  dplyr::select(any_of(c('Int_ID', 'geometry'))) %>%
  dplyr::mutate(X = st_coordinates(.)[, 1],
                Y = st_coordinates(.)[, 2]) #%>%
  #st_drop_geometry()

  
```

##### Arsenic

```{r Generate As predictions}

# Create list of internal ids with NA for As
As.NA.IDs = 
  SJVPondsDat.Clean %>% 
  filter(is.na(As)) %>%
  dplyr::select(any_of(c('Int_ID', predict.vars))) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x)))) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  drop_na() %>%
  dplyr::select(Int_ID) %>%
  pull()

# Create input data
As.NA.dat = 
  SJVPondsDat.Clean %>% 
  filter(Int_ID %in% As.NA.IDs) %>%
  dplyr::select(any_of(predict.vars)) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10)) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  as.data.frame(.)

As.log.pred.all = 
  predict(As.rF.log, As.NA.dat, na.action = na.omit)

As.preds =
  tibble(Int_ID = As.NA.IDs, As.preds = As.log.pred.all) %>%
  dplyr::mutate(across(As.preds, ~signif(10^.x, digits = 3)))

# Check against non detects
As.check = 
  SJVPondsDat.ND %>%
  dplyr::select(any_of(c('Int_ID', 'Detect_Limit', 'Oil_Field', 'As'))) %>%
  dplyr::left_join(., As.preds, by = c('Int_ID' = 'Int_ID')) %>%
  dplyr::left_join(., SJV.coords, by = c('Int_ID' = 'Int_ID')) %>%
  drop_na(As) %>%
  separate(As, into = c('As_qual', 'As'), 
             sep = '<', remove = TRUE, convert = TRUE) %>%
  dplyr::mutate(across(As_qual, ~ifelse(is.na(.x), '<', NA)),
         check = case_when(As.preds < As ~ 'Y',
                           As.preds > As ~ 'N'))

# Check As predictions against nondetects
As.check %>% group_by(check) %>% dplyr::summarise(counts = n())

```


##### Selenium

```{r Generate Se predictions}

# Create list of internal ids with NA for As
Se.NA.IDs = 
  SJVPondsDat.Clean %>% 
  filter(is.na(Se)) %>%
  dplyr::select(any_of(c('Int_ID', predict.vars))) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x)))) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  drop_na() %>%
  dplyr::select(Int_ID) %>%
  pull()

# Create input data
Se.NA.dat = 
  SJVPondsDat.Clean %>% 
  filter(Int_ID %in% Se.NA.IDs) %>%
  dplyr::select(any_of(predict.vars)) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10)) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  as.data.frame(.)

Se.log.pred.all = 
  predict(Se.rF.log, Se.NA.dat, na.action = na.omit)

Se.preds =
  tibble(Int_ID = Se.NA.IDs, Se.preds = Se.log.pred.all) %>%
  dplyr::mutate(across(Se.preds, ~signif(10^.x, digits = 3)))

# Check against non detects
Se.check = 
  SJVPondsDat.ND %>%
  dplyr::select(any_of(c('Int_ID', 'Detect_Limit', 'Oil_Field', 'Se'))) %>%
  dplyr::left_join(., Se.preds, by = c('Int_ID' = 'Int_ID')) %>%
  dplyr::left_join(., SJV.coords, by = c('Int_ID' = 'Int_ID')) %>%
  drop_na(Se) %>%
  separate(Se, into = c('Se_qual', 'Se'), 
             sep = '<', remove = TRUE, convert = TRUE) %>%
  dplyr::mutate(across(Se_qual, ~ifelse(is.na(.x), '<', NA)),
         check = case_when(Se.preds < Se ~ 'Y',
                           Se.preds > Se ~ 'N'))

# Check As predictions against nondetects
Se.check %>% group_by(check) %>% dplyr::summarise(counts = n())

# Visualize

Se.check %>%
  mutate(across(Int_ID, as.factor)) %>%
  ggplot() + 
  geom_segment(aes(x = Int_ID, xend = Int_ID,
                   y = Se, yend = 0)) +
  geom_point(aes(x = Int_ID, y = Se), colour = 'grey') +
  geom_point(aes(x = Int_ID, y = Se.preds, fill = check), 
             colour = 'black', shape = 21, stroke = 0.2,
             show.legend = FALSE) +
  scale_fill_manual(values = c('#d7191c', '#2c7bb6')) +
  scale_y_log10() +
  theme_classic2()

```

##### Map Predictions

```{r Get SJV Oil Fields}

SJV.Fields = 
  st_read('~/gis/CA_OilGas/Field_Boundary/Field_Boundary.shp') %>%
  filter(District == 'Inland') %>%
  st_transform(., crs = 3310)

```


```{r Create As Map predictions}

As.preds_sf =
  SJV.coords %>%
  left_join(SJVPondsDat.Clean %>% 
              dplyr::select(any_of(c('Int_ID', 'As', 'Oil_Field'))), 
            by = c('Int_ID' = 'Int_ID')) %>%
  left_join(As.preds, by = c('Int_ID' = 'Int_ID')) %>% 
  dplyr::mutate(As_map = case_when(is.na(As) ~ As.preds,
                                   TRUE ~ As),
                As_flag = case_when(is.na(As) ~ 'RFR',
                                   TRUE ~ 'MEAS')) %>%
  dplyr::select(!any_of(c('As', 'As.preds')))


As.w.preds_sf = 
  st_join(SJV.Fields, As.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(As = median(As_map, na.rm = TRUE))

As.wo.preds_sf = 
  st_join(SJV.Fields, As.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  filter(As_flag == 'MEAS') %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(As = median(As_map, na.rm = TRUE)) 

```


```{r Create Se Map predictions}

Se.preds_sf =
  SJV.coords %>%
  left_join(SJVPondsDat.Clean %>% 
              dplyr::select(any_of(c('Int_ID', 'Se', 'Oil_Field'))), 
            by = c('Int_ID' = 'Int_ID')) %>%
  left_join(Se.preds, by = c('Int_ID' = 'Int_ID')) %>% 
  dplyr::mutate(Se_map = case_when(is.na(Se) ~ Se.preds,
                                   TRUE ~ Se),
                Se_flag = case_when(is.na(Se) ~ 'RFR',
                                   TRUE ~ 'MEAS')) %>%
  dplyr::select(!any_of(c('Se', 'Se.preds')))


Se.w.preds_sf = 
  st_join(SJV.Fields, Se.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(Se = median(Se_map, na.rm = TRUE))

Se.wo.preds_sf = 
  st_join(SJV.Fields, Se.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  filter(Se_flag == 'MEAS') %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(Se = median(Se_map, na.rm = TRUE)) 

```


```{r Pull basemaps}

CA.state_sf = 
  st_read('~/gis/CensusBoundaries/CA_5m_Albers.shp') %>%
  st_transform(., crs = 3310)

GW.basins_sf = 
  st_read('~/gis/CA_GWbasins_Albers.shp')%>%
  st_transform(., crs = 3310)

SJV.margin_sf = 
  st_read('~/gis/Hydrology/California/Alluvial_Bnd.shp') %>%
  st_transform(., crs = 3310)

# Create map bounding box
disp_win = 
  st_sfc(st_point(c(-120.5, 34.9)), st_point(c(-118.5, 36.75)),
         crs = 4326) %>%
  st_transform(., crs = 3310) %>%
  st_coordinates(.)

```


```{r Map As predictions}


As.breaks = c(0, 11.81, 15.02, 17.14, 24.17, 35.32, 45.95, Inf)

# w/o RFR predictions
As.wo.preds_map = 
  ggplot() + 
  geom_sf(data = GW.basins_sf, fill = 'lightgrey') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = As.wo.preds_sf, 
          aes(fill = cut(As, breaks = As.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  #geom_sf(data = As.preds_sf, size = 1) + 
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = disp_win[,'X'], ylim = disp_win[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

ggsave('Figures/Raw/As_wo_preds.pdf', plot = As.wo.preds_map,
       height = 4.5, width = 3, units = 'in')


# w RFR predictions
As.w.preds_map = 
  ggplot() + 
  #geom_sf(data = CA.state_sf, fill = 'white') +
  geom_sf(data = GW.basins_sf, fill = 'lightgrey') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = As.w.preds_sf, 
          aes(fill = cut(As, breaks = As.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  #geom_sf(data = As.preds_sf, size = 1) + 
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = disp_win[,'X'], ylim = disp_win[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

ggsave('Figures/Raw/As_w_preds.pdf', plot = As.w.preds_map,
       height = 4.5, width = 3, units = 'in')
   
# make overlay for axes
#cords = 
#  st_sfc(st_point(c(0, -150000)), st_point(c(100000, -250000)),
 #        crs = 3310) %>%
 # st_transform(., crs = 4326) %>%
 # st_coordinates(.)


```



```{r Map Se predictions}

Se.breaks = c(0, 4.94, 13.4, 26.5, 34.4, 50.1, 97.5, Inf)

# w/o RFR predictions
Se.wo.preds_map = 
  ggplot() + 
  #geom_sf(data = CA.state_sf, fill = 'white') +
  geom_sf(data = GW.basins_sf, fill = 'lightgrey') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = Se.wo.preds_sf, 
          aes(fill = cut(Se, breaks = Se.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = disp_win[,'X'], ylim = disp_win[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

ggsave('Figures/Raw/Se_wo_preds.pdf', plot = Se.wo.preds_map,
       height = 4.5, width = 3, units = 'in')


# w RFR predictions
Se.w.preds_map = 
  ggplot() + 
  geom_sf(data = GW.basins_sf, fill = 'lightgrey') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = Se.w.preds_sf, 
          aes(fill = cut(Se, breaks = Se.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = disp_win[,'X'], ylim = disp_win[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

ggsave('Figures/Raw/Se_w_preds.pdf', plot = Se.w.preds_map,
       height = 4.5, width = 3, units = 'in')


```


```{r Map Oilfields}

Fields_map = 
  ggplot() + 
  #geom_sf(data = GW.basins_sf, fill = 'lightgrey') +
  geom_sf(data = SJV.margin_sf, fill = 'red') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = tst, 
          aes(colour = Oil_Field), size = 1, show.legend = TRUE) +
  coord_sf(xlim = disp_win[,'X'], ylim = disp_win[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

ggsave('Figures/Raw/FieldsMap.pdf', plot = Fields_map,
       height = 4.5, width = 8, units = 'in')

```



### Gradient boosted

```{r Set Gradient Boosted model controls}
# Same for all
control = 
  trainControl(method = 'repeatedcv', 
               number = 10, # 10 folds
               repeats = 5, # 5 repeated 10-fold CV
               selectionFunction = 'tolerance') # select best model considering
                                      # the % change in RMSE as mtry increases

gb.tunegrid = 
  expand.grid(interaction.depth=c(1, 3, 5), 
              n.trees = (0:50)*50, 
              shrinkage=c(0.01, 0.001),
              n.minobsinnode=10)

```


```{r Train GB RF on log data, message=FALSE, warning=FALSE}

# run Random Forests on log 10 transformed data
As.gb.log = 
  caret::train(As~.,
               data = As.tr.log,
               method = 'gbm', 
               trControl = control, 
               metric = 'RMSE', 
               tuneGrid = gb.tunegrid, 
               na.action = na.omit,
               verbose = FALSE)

Se.gb.log = 
  caret::train(Se~., 
               data = Se.tr.log, 
               method = 'gbm', 
               trControl = control, 
               metric = 'RMSE', 
               tuneGrid = gb.tunegrid, 
               na.action = na.omit,
               verbose = FALSE)

```


```{r GB RF model diagonistics}
As.gb.log$bestTune
As.gb.log$finalModel

As.gb.log$results %>%
  filter(n.trees == 250 & shrinkage == 0.01)

Se.gb.log$bestTune
Se.gb.log$finalModel

Se.gb.log$results %>%
  filter(n.trees == 350 & shrinkage == 0.01)

```
