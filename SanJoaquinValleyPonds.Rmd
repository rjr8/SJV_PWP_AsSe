---
title: "San Joaquin Valley Ponds"
author: "Rob Rossi"
date: "1/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)

# Establish directory
here::i_am('SJV_PWP_AsSe.Rproj')

# Load script of custom functions
source('Rcustomfunctions.R')

```


## Initialize

```{r Setup, message=FALSE, warning=FALSE, include=FALSE}
# setup packages
req.packages = c('rstatix', 'sf', 'magrittr', 'ggpubr', 'pals', 
                 'lubridate', 'iml', 'pdp', 'BAMMtools', 'corrplot', 
                 'here', 'randomForest', 'caret', 'MASS', 
                 'RColorBrewer', 'moments', 'Hmisc', 'tidyverse')

setupPackages(req.packages)

# setup visualization options
theme_set(theme_classic2(base_family = 'Arial'))

```

## Load and Clean Data

### Geospatial Data

```{r Load sample geospatial data}

load(here::here('geospatial_data','SJVspatialData.Rda')) 

```


### Chemical Data

#### External Geochemical Endmember Data

```{r Load external data for analyses}
# Load Geochemical endmember data

## USGS Natl Geochem DB
load(here::here('geochemical_data','USGS_NGDB_rock_SJV.Rda')) 

## CalGEM Well Stimulation Dataset
load(here::here('geochemical_data','CalGEM_WSD.Rda')) 

```

#### Raw Processing

```{r Load Raw Chemical Data, message=FALSE, warning=FALSE}

# Load raw chemical data
load(here::here('geochemical_data','SJVPondsDat_raw.Rda')) 

# Remove samples collected after 1 Jan 2020, and those without location data
SJVPondsDat = 
  SJVPondsDat.raw %>%
  # Convert date to a date
  dplyr::mutate(across(Sampling_Date, ~as.Date(.x, format = '%m/%d/%Y'))) %>%
  # Remove 2020 McKittrick Data
  filter(Sampling_Date < '2020-01-01') %>%
  # drop the 1 mystery sample
  drop_na(Global_ID)

# clean raw data from memory
rm(SJVPondsDat.raw)

```

### Clean Chemical Data

```{r Clean data, message=FALSE, warning=FALSE}

# Define which columns are factors 
factors = c('Global_ID', 'Oil_Field', 'Facility_Name', 
            'County', 'Detect_Limit')

# These columns are not essential for any analyses 
dropCols = c('Link', 'Source_Type', 'Datum', 'Latitude', 
             'Longitude', 'Geography_Description')

# Create data frames of clean data and nondetects
createCleanandNDdfs(SJVPondsDat, name ='SJVPondsDat',
                    factorCols = factors, colsToDrop = dropCols,
                    firstChemDatColname = 'Alkalinity_CaCO3')
  
```


```{r Join spatial variables to dfs, message=FALSE, warning=FALSE}

# Join to cleaned data
SJVPondsDat.Clean %<>%
  left_join(SJV.spatial.vars, by = c('Int_ID' = 'Int_ID'))

# Join to non-detects
SJVPondsDat.ND %<>%
  left_join(SJV.spatial.vars, by = c('Int_ID' = 'Int_ID'))
```


```{r Calc Charge Balances and Molar Ratios, message=FALSE, warning=FALSE}

# Calculate sample charge balances
SJVPondsDat.Clean %<>%
  calcChargeBalance(., CBerrorFlag = 20, uniqueIdentifier = 'Int_ID')

# Calculate sample molar ratios
SJVPondsDat.Clean %<>% calcElementalRatios(.)

```


## Create Reference Map of SJV Oilfields


```{r Get SJV valley margin}

SJV.margin_sf = 
  read_sf(here::here('geospatial_data/shapefiles/',
                     'Alluvial_Bnd.shp')) %>%
  # Reproject to NAD_1983_California_Teale_Albers (meters)
  st_transform(., crs = 3310)

```


```{r Create Vector of Sampled Oil Fields}

Sampled.fields = 
  unique(SJVPondsDat.Clean$Oil_Field) %>% as.character(.)

```


```{r Get SJV Oil Fields}

SJV.Fields = 
  read_sf(here::here('geospatial_data/shapefiles/',
                     'Field_Boundary.shp')) %>%
  filter(District == 'Inland') %>%
  # Reproject to NAD_1983_California_Teale_Albers (meters)
  st_transform(., crs = 3310) %>% 
  dplyr::mutate(
    across(NAME, toupper),
    across(NAME, 
           ~case_when(.x == 'BELRIDGE, NORTH' ~ 'NORTH BELRIDGE',
                      .x == 'BELRIDGE, SOUTH' ~ 'SOUTH BELRIDGE',
                      .x == 'CARNEROS CREEK'  ~ 'CARNEROS',
                      TRUE                    ~ as.character(.x))),
    samps = if_else(NAME %in% Sampled.fields, 1, 0))

```


```{r Get Facility Centroids}

SJV.Samps = 
  read_sf(here::here('geospatial_data/shapefiles/',
                     'SJVCompSamps.shp'))

```


This bounding box is also used for the predictions map in chunk XX
```{r Create Map Bounding Box}

display_window = 
  st_sfc(st_point(c(-120.5, 34.9)), st_point(c(-118.5, 36.75)),
         crs = 4326) %>%
  st_transform(., crs = 3310) %>%
  st_coordinates(.)

```


```{r Map Oilfields}

Fields_map = 
  ggplot() + 
  geom_sf(data = SJV.margin_sf, fill = 'white', colour = 'black') +
  geom_sf(data = SJV.Fields %>% filter(samps == 0), 
          fill = '#d1d3d4', alpha = 0.3) +
  geom_sf(data = SJV.Fields %>% filter(samps == 1), 
          fill = '#d1d3d4') + 
  geom_sf(data = SJV.Samps, alpha = 0.45, size = 1) +
  coord_sf(xlim = display_window[,'X'], 
           ylim = display_window[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

Fields_map


ggsave(here::here('raw_figures/', 'FigureS1_raw.pdf'), 
       plot = Fields_map, height = 4.5, width = 8, units = 'in')

# remove sampled fields list from memory
rm(Sampled.fields)

```


## General Data Summary

### Detection Counts and Summary Statistics


```{r Create list of analytes to summarise}

summary.analytes = 
  c('Alkalinity_CaCO3', 'Specific_Conductance', 'TDS', 'pH', 'Na', 'K', 
    'Ca', 'Mg', 'Ba', 'Sr', 'HCO3', 'CO3', 'Cl', 'SO4', 'B', 'Fe', 'Mn', 
    'NH4', 'NO3', 'As', 'Se', 'Oil_Grease', 'Deuterium', 'Oxygen_18')

```


Get the number of non-detections for each analyte.

```{r Count NDs, message=FALSE, warning=FALSE}

nonDetects = 
  SJVPondsDat.ND %>%
  dplyr::select(all_of(summary.analytes)) %>%
  dplyr::summarise(across(everything(), ~sum(!is.na(.x)))) %>%
  pivot_longer(cols = everything(),
               names_to = 'Analyte',
               values_to = 'nondetects') %>%
  arrange(match(Analyte, summary.analytes))

```

Calculate summary statistics for each analyte.

```{r Create summary table, message=FALSE, warning=FALSE}

detectsSummary = 
  SJVPondsDat.Clean %>%
  dplyr::select(all_of(summary.analytes)) %>% 
  pivot_longer(cols = everything(),
               names_to = 'Analyte',
               values_to = 'Concentration') %>%
  group_by(Analyte) %>%
  # Generate summary statistics of analytes
  dplyr::summarise(detects = sum(!is.na(Concentration)),
                   Min = min(Concentration, na.rm = TRUE),
                   Med = median(Concentration, na.rm = TRUE),
                   Max = max(Concentration, na.rm = TRUE),
                   `5th` = quantile(Concentration, probs = 0.05, na.rm = TRUE),
                   `25th` = quantile(Concentration, probs = 0.25, 
                                     na.rm = TRUE),
                   `75th` = quantile(Concentration, probs = 0.75, 
                                     na.rm = TRUE),
                   `95th` = quantile(Concentration, probs = 0.95, 
                                     na.rm = TRUE)) %>%
  arrange(match(Analyte, summary.analytes)) %>%
  # add in counts of non detections for each analyte
  add_column(NDs = nonDetects$nondetects, .after = 'detects') %>%
  # round to 3 sigfigs
  dplyr::mutate(across(c(4:10), ~signif(.x, digits = 3))) %>%
  dplyr::mutate(`Detections (%)` = 
                  paste(as.character(detects),
                        paste(as.character(round(100*(detects/(detects + NDs)),
                                                 digits = 1)), sep = ')'), 
                        sep = ' ('), .after = Analyte) %>%
  dplyr::mutate(across(`Detections (%)`, ~paste0(.x, ')'))) %>%
  dplyr::select(!c(detects, NDs))

# export summary table (Table S1)
write_csv(detectsSummary, here::here('tables/','TableS1.csv'))

```


### Look at Charge Balance Errors

How many Charge Balance Errors (CBE) are greater than 20%?
```{r Count CBEs}

print(paste('Number of CBEs greater than 20%:', 
            SJVPondsDat.Clean %>% 
              filter(!is.na(Ca) & !is.na(Cl)) %>%
              filter(abs(CBE) >= 20) %>% 
              count()))

```


```{r Generate Figure S2, message=FALSE, warning=FALSE}

CBE.sigma = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Ca) & !is.na(Cl)) %>%
  summarise(sigma = sd(CBE)) %>%
  pull(sigma)

CBE.Hist = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Ca) & !is.na(Cl)) %>%
  ggplot(aes(x=CBE)) + 
  geom_histogram(colour = 'black', fill = '#deeaf7', binwidth = 5) +
  geom_vline(xintercept=2*CBE.sigma) + 
  geom_vline(xintercept=-2*CBE.sigma) +
  labs(title = '', x = 'Charge Balance Error', y = 'Count') +
  theme_classic2()

CBE.Hist

ggsave(here::here('raw_figures/', 'FigureS2_raw.pdf'), plot = CBE.Hist, 
       width = 4, height = 2.5, units = 'in', limitsize = TRUE)
```


## Random Forest

### Predictor variables

Before building models put together a vector of all explanatory variables:

Tulare Basin Plan Analytes
- SC:       Specific Conductance                                (μS/cm)
- TDS:      Total Dissolved Solids                              (mg/L)
- Cl:       Chloride                                            (mg/L)
- B:        Boron                                               (mg/L)

Spatial Variables

  SoilGRIDs
- BD		    Bulk density of fine earth fraction                 (g/cm3)
- CEC		    Cation Exchange Capacity                            (cmol(c)/kg)
- cf		    Volumetric % fragments > 2 mm                       (%)
- clay		  Mass % clay particles (< 0.002 mm)                  (%)
- pH_soil	  Soil pH                                             (pH)
- sand		  Mass % sand particles (> 0.05 mm)		                (%)
- silt		  Mass % silt particles (≥ 0.002 mm & ≤ 0.05 mm)	    (%)
- SOC		    Soil organic carbon in fine earth fraction	        (g/kg)
- MAEt	    Mean Annual Reference Evapotranspiration	          (mm/yr)
- MAP       Mean Annual Precipitation			                      (mm/yr)
- AxisSide  Location of sample in relation to valley axis

  STATSGO2
- slope_wa  Slope gradient, weighted average                    (%)
- aws_0.150 Available water storage, 0-150 cm                   (cm)
- hydrgrp   Hydrologic group                                

  USGS Geochem
- C_As      Soil C horizon As content                           (mg/kg)
- C_Fe		  Soil C horizon Fe content                           (%)
- C_Mn		  Soil C horizon Mn content                           (mg/kg)
- C_Se		  Soil C horizon Se content                           (mg/kg)

  Groundwater
- WLBLS     Depth of interpolated avg water below land surface  (m)  


```{r Create vector of predictor variables}

# create vector of spatial variables
spat.vars = 
  colnames(SJV.spatial.vars)[-str_detect(colnames(SJV.spatial.vars), 'Int_ID')] 

# create vector of Tulare Basin Plan analytes
Tulare.vars = c('Specific_Conductance', 'TDS', 'Cl', 'B') 

predict.vars = c('Oil_Field', Tulare.vars, spat.vars) 

```


### Clean Data for Model Building

```{r Create simplified data for model creation}

# Arsenic
As.rF.input.raw =
  SJVPondsDat.Clean %>%
  filter(case_when(!is.na(Ca) ~ CBE_flag == 'N',
                   TRUE ~ CBE_flag == 'N' | CBE_flag == 'Y')) %>%
  dplyr::select(any_of(c('As', predict.vars))) %>%
  # remove missing values
  drop_na(As) %>%
  as.data.frame(.)


# Selenium
Se.rF.input.raw =
  SJVPondsDat.Clean %>%
  filter(case_when(!is.na(Ca) ~ CBE_flag == 'N',
                   TRUE ~ CBE_flag == 'N' | CBE_flag == 'Y')) %>%
  dplyr::select(any_of(c('Se', predict.vars))) %>%
  # remove missing values
  drop_na(Se) %>%
  as.data.frame(.)

```

#### Check for Correlations

```{r Arsenic correlations}

As.raw.cor = 
  As.rF.input.raw %>%
  dplyr::select(-where(is.factor))

As.cor = rcorr(as.matrix(As.raw.cor), type = 'spearman')
As.cor.r = As.cor$r
As.cor.p = As.cor$P

findCorrelation(As.cor.r, cutoff = 0.85, verbose = TRUE, names = TRUE)

```


```{r Generate Figure S3}

# Save corplot as pdf
pdf(file = here::here('raw_figures/','FigureS4corr_raw.pdf'))
  corrplot(As.cor.r, method = 'number', diag = FALSE, 
           type ='upper', tl.cex = 0.8, number.cex = 0.6, 
           number.digits = 2)
dev.off()


# Save corplot pvals as pdf
pdf(file = here::here('raw_figures/','FigureS4pval_raw.pdf'))
  corrplot(As.cor.r, p.mat = As.cor.p, method = 'color', diag = FALSE, 
           type = 'upper', sig.level = c(0.001, 0.01, 0.05), 
           pch.cex = 0.9, insig = 'label_sig', pch.col = 'grey20')
dev.off()

```

These figures were combined in Adobe Illustrator.


```{r Selenium correlations}
Se.raw.cor = 
  Se.rF.input.raw %>%
  dplyr::select(-where(is.factor)) 

Se.cor = rcorr(as.matrix(Se.raw.cor), type = 'spearman')
Se.cor.r = Se.cor$r
Se.cor.p = Se.cor$P
 
findCorrelation(Se.cor.r, cutoff=0.85, verbose = TRUE, names = TRUE)

```


```{r Generate Figure S4}

# Save corrplot as pdf
pdf(file = here::here('raw_figures/','FigureS5corr_raw.pdf'))
  corrplot(Se.cor.r, method = 'number', diag = FALSE, 
           type ='upper', tl.cex = 0.8, number.cex = 0.6, 
           number.digits = 2)
dev.off()

# Save corplot pvals as pdf
pdf(file = here::here('raw_figures/','FigureS5pval_raw.pdf'))
  corrplot(Se.cor.r, p.mat = Se.cor.p, method = 'color', diag = FALSE, 
           type = 'upper', sig.level = c(0.001, 0.01, 0.05), 
           pch.cex = 0.9, insig = 'label_sig', pch.col = 'grey20')
dev.off()

```

These figures were combined in Adobe Illustrator.

#### Remove Correlated Variables/Create input data

Missing Cl or B values were imputed with the median value of these analytes measured in each field.

```{r Identify NA rows in As input data}

As.NAs =
  As.rF.input.raw %>% 
  filter(is.na(Cl) | is.na(B)) %>% 
  pull(Oil_Field) %>% as.character(.)

# Calculate median value per field
As.meds = 
  SJVPondsDat.Clean %>% 
  group_by(Oil_Field) %>% 
  summarise(median(Cl, na.rm = TRUE),
            median(B, na.rm = TRUE)) %>%
  filter(Oil_Field %in% As.NAs)

As.meds

```


```{r Identify NA rows in Se input data}

Se.NAs =
  Se.rF.input.raw %>% 
  filter(is.na(Cl) | is.na(B)) %>% 
  pull(Oil_Field) %>% as.character(.)

# Calculate median value per field
Se.meds = 
  SJVPondsDat.Clean %>% 
  group_by(Oil_Field) %>% 
  summarise(median(Cl, na.rm = TRUE),
            median(B, na.rm = TRUE)) %>%
  filter(Oil_Field %in% Se.NAs)

Se.meds

```


```{r Determine formula to impute missing TDS from EC}

# Determine relationship of SC and TDS to impute missing TDS values
TDS_SC.plt = 
  SJVPondsDat.Clean %>% 
  ggplot(aes(x= log10(Specific_Conductance), y = log10(TDS))) + 
  geom_smooth(method = 'lm', colour = 'black') +
  geom_point(colour = 'dodgerblue4', alpha = 0.4) + theme_classic2()

ggsave(here::here('raw_figures/', 'FigureS6_raw.pdf'), 
       plot = TDS_SC.plt, width = 3.5, height = 3.5, units = 'in')

# fit linear model to data
fit = 
  lm(log10(TDS) ~ log10(Specific_Conductance), data = SJVPondsDat.Clean)

summary(fit)

TDS_SC.plt

```


```{r Drop correlated vars, trans vars}

# Create vector of predictors to drop
predicts_to_drop = c('clay', 'sand', 'Specific_Conductance', 'TDS')

# create vector of variables to log10 transform
log_trans_vars = c('As', 'Se', 'Cl', 'B')

## Arsenic
As.rF.input = 
  As.rF.input.raw %>% 
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(Cl, ~case_when(is.na(.x) & Oil_Field == 'KERN FRONT' ~ 87,
                          is.na(.x) & Oil_Field == 'ASPHALTO' ~ 16070,
                         TRUE ~ .x)), # impute missing Cl
    across(B, ~case_when(is.na(.x) & Oil_Field == 'KERN FRONT' ~ 0.92,
                         is.na(.x) & Oil_Field == 'DEER CREEK' ~ 0.68,
                         TRUE ~ .x)), # impute missing B
    across(any_of(log_trans_vars), log10),
    TDS_Cl = TDS-Cl) %>%  # see influence of sulfates vs chlorides
  dplyr::select(-any_of(c(predicts_to_drop))) # drop correlated vars


## Selenium  
Se.rF.input = 
  Se.rF.input.raw %>% 
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                  (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(Cl, ~if_else(is.na(.x), 16070, .x)), # impute missing Cl
    across(any_of(log_trans_vars), log10),
    TDS_Cl = TDS-Cl) %>%  # see influence of sulfates vs chlorides
  dplyr::select(-any_of(c(predicts_to_drop))) # drop correlated vars

```


#### Visualize Distributions of Transformed Data

```{r Generate Figure S7, warning=FALSE}

As.RFR.dens.plt = 
  As.rF.input %>% 
  dplyr::select(-where(is.factor)) %>% 
  pivot_longer(cols = everything(), 
               names_to = 'var', 
               values_to = 'val') %>% 
  ggplot(aes(x=val)) + geom_density() + 
  facet_wrap(~var, scales='free') + 
  theme_classic2()

As.RFR.dens.plt

ggsave(here::here('raw_figures/', 'FigureS7_raw.pdf'), 
       plot = As.RFR.dens.plt, width = 6.5, height = 4, units = 'in')

```


```{r Generate Figure S8, warning=FALSE}

Se.RFR.dens.plt = 
  Se.rF.input %>% 
  dplyr::select(-where(is.factor)) %>%
  pivot_longer(cols = everything(), 
               names_to = 'var', 
               values_to = 'val') %>% 
  ggplot(aes(x=val)) + geom_density() + 
  facet_wrap(~var, scales='free') + 
  theme_classic2()

Se.RFR.dens.plt

ggsave(here::here('raw_figures/', 'FigureS8_raw.pdf'), 
       plot = Se.RFR.dens.plt, width = 6.5, height = 4, units = 'in')

```


### Random Forests

#### Train/Test Splits

For each trace, the train data set (used to build the model) will consist of 80% of the samples with a detectable amount of that analyte, and the test data set (used to validate the model) will be the remaining 20% of the samples with detectable concentrations.

```{r Caret test train splits}

set.seed(429)

## Arsenic log10 transformed 
As.train = 
  createDataPartition(y = As.rF.input$As, p = 0.80, list = FALSE)

As.tr.log = As.rF.input[As.train,] 
As.tst.log = As.rF.input[-As.train,]


## Selenium log10 transformed
Se.train = 
  createDataPartition(y = Se.rF.input$Se, p = 0.80, list = FALSE)

Se.tr.log = Se.rF.input[Se.train,]
Se.tst.log = Se.rF.input[-Se.train,]

```


#### Create Model Defaults

```{r Set model controls}

# Same for all
control = 
  trainControl(method = 'repeatedcv', 
               number = 10, # 10 folds
               repeats = 5, # 5 repeated 10-fold CV
               selectionFunction = 'tolerance') 
              # select best model considering the % change 
              # in RMSE as mtry increases

tunegrid = expand.grid(mtry = 1:21)

```


```{r UNCESS}

ctrl = 
  trainControl(method = 'repeatedcv', 
               number = 10, # 10 folds
               repeats = 5, # 5 repeated 10-fold CV
               selectionFunction = 'oneSE') # select best model considering
                                      # the % change in RMSE as mtry increases

```


#### Build RFR Models for Log10 Transformed Data

```{r Caret run random forests log 10}

# run Random Forests on log 10 transformed data
As.rF.log = 
  caret::train(As~., data = As.tr.log, method = 'rf', 
               trControl = control, metric = 'RMSE', 
               tuneGrid = tunegrid, na.action = na.omit)

Se.rF.log = 
  caret::train(Se~., data = Se.tr.log, method = 'rf', 
               trControl = control, metric = 'RMSE', 
               tuneGrid = tunegrid, na.action = na.omit)

```


```{r Tabulate training metrics}

results.train = 
  tibble::tibble(RFR = c('As', 'Se')) %>%
  # Add training results
  bind_cols(
    # Add best mtry
    bind_rows(As.rF.log$bestTune, Se.rF.log$bestTune),
    # Add number of training samples
    n = c(nrow(As.tr.log), nrow(Se.tr.log)),
    # Add accuracy metrics
    bind_rows(As.rF.log$results[pull(As.rF.log$bestTune),], 
              Se.rF.log$results[pull(Se.rF.log$bestTune),])
    ) %>%
  dplyr::select(-c('mtry...4', ends_with('SD')))

```



##### Visualize RSME for Log10 Tranformed Model

```{r Create Figure S8, message=FALSE}

# Create RMSE plots for each trace

As.log.RMSE.plt =
  As.rF.log$results %>%
  ggplot(aes(x = mtry, y = 10^RMSE)) +
  geom_line(linetype = 'dashed', colour = 'grey40') +
  geom_errorbar(aes(ymin = 10^(RMSE-RMSESD), ymax = 10^(RMSE+RMSESD)), 
                width = 0.4, color = 'grey') +
  geom_point(size = 2) +
  labs(title = 'Arsenic', x = '# of variables', y = 'RMSE') +
  theme(legend.position = 'none') +
  theme_classic2()

ggsave(
  here::here('raw_figures/', 'FigureS9a_raw.pdf'), plot = As.log.RMSE.plt, 
  units = 'in', width = 5, height = 2.5, limitsize = TRUE)

As.log.RMSE.plt

Se.log.RMSE.plt =
  Se.rF.log$results %>%
  ggplot(aes(x = mtry, y = 10^RMSE)) +
  geom_line(linetype = 'dashed', colour = 'grey40') +
  geom_errorbar(aes(ymin = 10^(RMSE-RMSESD), ymax = 10^(RMSE+RMSESD)), 
                width = 0.4, color = 'grey') +
  geom_point(size = 2) +
  labs(title = 'Selenium', x = '# of variables', y = 'RMSE') +
  theme(legend.position = 'none') +
  theme_classic2()


ggsave(
  here::here('raw_figures/', 'FigureS9b_raw.pdf'), plot = Se.log.RMSE.plt, 
  units = 'in', width = 5, height = 2.5, limitsize = TRUE)

Se.log.RMSE.plt

```


##### Visualize Variable Importance for Log10 Tranformed Model

Visualize variable importance for As model

```{r Create Figure 3a}

As.y.imp = As.tr.log %>% drop_na()

As.pred.imp = 
  Predictor$new(As.rF.log,
                data = As.y.imp[which(names(As.y.imp) != 'As')],
                y = As.y.imp$As)

As.imp = FeatureImp$new(As.pred.imp, loss = 'rmse')

As.imp.plt = plot(As.imp) + theme_classic2()

As.imp.plt

ggsave(here::here('raw_figures/', 'Figure3a_raw.pdf'), 
       plot = As.imp.plt, height = 4, width = 4, units = 'in')

```


Visualize variable importance for As model

```{r Create Figure 3b}

Se.y.imp = Se.tr.log %>% drop_na()

Se.pred.imp = 
  Predictor$new(Se.rF.log,
                data = Se.y.imp[which(names(Se.y.imp) != 'Se')],
                y = Se.y.imp$Se)

Se.imp = FeatureImp$new(Se.pred.imp, loss = 'rmse')

Se.imp.plt = plot(Se.imp) + theme_classic2()

Se.imp.plt

ggsave(here::here('raw_figures/', 'Figure3b_raw.pdf'), 
       plot = Se.imp.plt, height = 4, width = 4, units = 'in')

```


##### Compare Model Predictions vs. Observations for Log10 Tranformed Model

```{r Compare log10 predictions to observations}

# use rf to predict test set
As.log.pred = predict(As.rF.log, As.tst.log, na.action = na.omit)
Se.log.pred = predict(Se.rF.log, Se.tst.log, na.action = na.omit)

# create a data frame of various errors for plotting
As.log.err = 
  postResample(pred = As.log.pred, obs = As.tst.log$As) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab') %>%
  dplyr::rename(., err = `.`) %>%
  dplyr::mutate(across(2, ~signif(.x, digits = 3))) %>%
  pivot_wider(names_from = lab,
              values_from = err) %>%
  dplyr::rename_with(., ~paste0(.x, '_tst'))

Se.log.err = 
  postResample(pred = Se.log.pred, obs = Se.tst.log$Se) %>%
  as.data.frame(.) %>%
  rownames_to_column(., 'lab')  %>%
  dplyr::rename(., err = `.`) %>%
  dplyr::mutate(across(2, ~signif(.x, digits = 3))) %>%
  pivot_wider(names_from = lab,
              values_from = err) %>%
  dplyr::rename_with(., ~paste0(.x, '_tst'))

```


Create a table with test and train errors

```{r Create Table 1}

results.table = 
  results.train %>% 
  bind_cols(
    n_tst = c(nrow(As.tst.log), nrow(Se.tst.log)),
    bind_rows(As.log.err, Se.log.err)) %>%
  dplyr::mutate(
    across(starts_with(c('RMSE', 'MAE')),
           ~signif(10^.x, digits = 3)),
    across(starts_with('Rsquared'), ~signif(.x, digits = 3)))

results.table
    
# export summary table of model accuracy (Table 1)
write_csv(results.table, here::here('tables/','Table1.csv'))

```


#### Plot Predictions vs. Observations

Plot predicted As vs. observed As
```{r Create Figure S10a}
As.preds_vs_obs.plt =
  ggplot() + 
  geom_abline(intercept = 0, linetype = 2) +
  geom_point(aes(x = As.log.pred, y = As.tst.log$As),
             alpha = 0.4) + 
  xlim(0,3) + ylim(0,3) +
  labs(x = 'Predicted log10(As) (µg/L)', 
       y = 'Observed log10(As) (µg/L)') +
  theme_classic2()

As.preds_vs_obs.plt


ggsave(here::here('raw_figures/', 'FigureS10a_raw.pdf'), 
       plot = As.preds_vs_obs.plt,
       height = 4.5, width = 4.5, units = 'in')

```


Plot predicted Se vs. observed Se
```{r Create Figure S10b}
Se.preds_vs_obs.plt =
  ggplot() + 
  geom_abline(intercept = 0, linetype = 2) +
  geom_point(aes(x = Se.log.pred, y = Se.tst.log$Se),
             alpha = 0.4) + 
  xlim(0,3) + ylim(0,3) +
  labs(x = 'Predicted log10(Se) (µg/L)', 
       y = 'Observed log10(Se) (µg/L)') +
  theme_classic2()

Se.preds_vs_obs.plt

ggsave(here::here('raw_figures/', 'FigureS10b_raw.pdf'),
       plot = Se.preds_vs_obs.plt,
       height = 4.5, width = 4.5, units = 'in')

```


#### Predict missing data

```{r Create sample coords for mapping}

# Create df of sample coords
SJV.coords = 
  st_read(here::here('geospatial_data/shapefiles/',
                     'SJVCompSamps.shp')) %>%
  dplyr::select(any_of(c('Int_ID', 'geometry'))) %>%
  dplyr::mutate(X = st_coordinates(.)[, 1],
                Y = st_coordinates(.)[, 2])
  
```

##### Arsenic

```{r Generate As predictions}

# Create list of internal ids with NA for As
As.NA.IDs = 
  SJVPondsDat.Clean %>% 
  filter(is.na(As)) %>%
  dplyr::select(any_of(c('Int_ID', predict.vars))) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10),
    TDS_Cl = TDS-Cl) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  drop_na() %>%
  dplyr::select(Int_ID) %>%
  pull()

# Create input data
As.NA.dat = 
  SJVPondsDat.Clean %>% 
  filter(Int_ID %in% As.NA.IDs) %>%
  dplyr::select(any_of(predict.vars)) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10),
    TDS_Cl = TDS-Cl) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  as.data.frame(.)

As.log.pred.all = 
  predict(As.rF.log, As.NA.dat, na.action = na.omit)

As.preds =
  tibble(Int_ID = As.NA.IDs, As.preds = As.log.pred.all) %>%
  dplyr::mutate(across(As.preds, ~signif(10^.x, digits = 3)))

```


##### Selenium

```{r Generate Se predictions}

# Create list of internal ids with NA for As
Se.NA.IDs = 
  SJVPondsDat.Clean %>% 
  filter(is.na(Se)) %>%
  dplyr::select(any_of(c('Int_ID', predict.vars))) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10),
    TDS_Cl = TDS-Cl) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  drop_na() %>%
  dplyr::select(Int_ID) %>%
  pull()

# Create input data
Se.NA.dat = 
  SJVPondsDat.Clean %>% 
  filter(Int_ID %in% Se.NA.IDs) %>%
  dplyr::select(any_of(predict.vars)) %>%
  dplyr::mutate(
    across(TDS, ~if_else(is.na(.x),
                         (0.972434*log10(Specific_Conductance))-0.100895,
                  log10(.x))), # impute missing TDS, trans to log10
    across(any_of(log_trans_vars), log10),
    TDS_Cl = TDS-Cl) %>%
  dplyr::select(-any_of(predicts_to_drop)) %>% # drop correlated vars
  as.data.frame(.)

Se.log.pred.all = 
  predict(Se.rF.log, Se.NA.dat, na.action = na.omit)

Se.preds =
  tibble(Int_ID = Se.NA.IDs, Se.preds = Se.log.pred.all) %>%
  dplyr::mutate(across(Se.preds, ~signif(10^.x, digits = 3)))

```


##### Map Predictions


```{r Create As Map predictions}

As.preds_sf =
  SJV.coords %>%
  left_join(SJVPondsDat.Clean %>% 
              dplyr::select(any_of(c('Int_ID', 'As', 'Oil_Field'))), 
            by = c('Int_ID' = 'Int_ID')) %>%
  left_join(As.preds, by = c('Int_ID' = 'Int_ID')) %>% 
  dplyr::mutate(As_map = case_when(is.na(As) ~ As.preds,
                                   TRUE ~ As),
                As_flag = case_when(is.na(As) ~ 'RFR',
                                   TRUE ~ 'MEAS')) %>%
  dplyr::select(!any_of(c('As', 'As.preds')))


As.w.preds_sf = 
  st_join(SJV.Fields, As.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(As = median(As_map, na.rm = TRUE))

As.wo.preds_sf = 
  st_join(SJV.Fields, As.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  filter(As_flag == 'MEAS') %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(As = median(As_map, na.rm = TRUE)) 

```


```{r Create Se Map predictions}

Se.preds_sf =
  SJV.coords %>%
  left_join(SJVPondsDat.Clean %>% 
              dplyr::select(any_of(c('Int_ID', 'Se', 'Oil_Field'))), 
            by = c('Int_ID' = 'Int_ID')) %>%
  left_join(Se.preds, by = c('Int_ID' = 'Int_ID')) %>% 
  dplyr::mutate(Se_map = case_when(is.na(Se) ~ Se.preds,
                                   TRUE ~ Se),
                Se_flag = case_when(is.na(Se) ~ 'RFR',
                                   TRUE ~ 'MEAS')) %>%
  dplyr::select(!any_of(c('Se', 'Se.preds')))


Se.w.preds_sf = 
  st_join(SJV.Fields, Se.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(Se = median(Se_map, na.rm = TRUE))

Se.wo.preds_sf = 
  st_join(SJV.Fields, Se.preds_sf, join = st_contains) %>%
  drop_na(Int_ID) %>%
  filter(Se_flag == 'MEAS') %>%
  dplyr::group_by(Oil_Field) %>%
  dplyr::summarise(Se = median(Se_map, na.rm = TRUE)) 

```


```{r Pull basemaps}

GW.basins_sf = 
  read_sf(here::here('geospatial_data/shapefiles/',
                     'CA_GWbasins_Albers.shp')) %>%
  st_transform(., crs = 3310)

```


```{r Map As predictions}

As.breaks = c(0, 11.81, 15.02, 17.14, 24.17, 35.32, 45.95, Inf)

# w/o RFR predictions
As.wo.preds_map = 
  ggplot() + 
  geom_sf(data = GW.basins_sf, fill = '#c2b59b') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = As.wo.preds_sf, 
          aes(fill = cut(As, breaks = As.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  #geom_sf(data = As.preds_sf, size = 1) + 
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = display_window[,'X'], 
           ylim = display_window[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

As.wo.preds_map

ggsave(here::here('raw_figures/', 'Figure2a_raw.pdf'),
       plot = As.wo.preds_map, height = 4.5, width = 3, units = 'in')


# w RFR predictions
As.w.preds_map = 
  ggplot() + 
  #geom_sf(data = CA.state_sf, fill = 'white') +
  geom_sf(data = GW.basins_sf, fill = '#c2b59b') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = As.w.preds_sf, 
          aes(fill = cut(As, breaks = As.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  #geom_sf(data = As.preds_sf, size = 1) + 
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = display_window[,'X'], 
           ylim = display_window[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

As.w.preds_map

ggsave(here::here('raw_figures/', 'Figure2b_raw.pdf'),
       plot = As.w.preds_map, height = 4.5, width = 3, units = 'in')
   
```


```{r Map Se predictions}

Se.breaks = c(0, 4.94, 13.4, 26.5, 34.4, 50.1, 97.5, Inf)

# w/o RFR predictions
Se.wo.preds_map = 
  ggplot() + 
  geom_sf(data = GW.basins_sf, fill = '#c2b59b') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = Se.wo.preds_sf, 
          aes(fill = cut(Se, breaks = Se.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = display_window[,'X'], 
           ylim = display_window[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

Se.wo.preds_map

ggsave(here::here('raw_figures/', 'Figure2c_raw.pdf'),
       plot = Se.wo.preds_map, height = 4.5, width = 3, units = 'in')


# w RFR predictions
Se.w.preds_map = 
  ggplot() + 
  geom_sf(data = GW.basins_sf, fill = '#c2b59b') +
  geom_sf(data = SJV.Fields) + 
  geom_sf(data = Se.w.preds_sf, 
          aes(fill = cut(Se, breaks = Se.breaks, include.lowest = TRUE)),
          show.legend = FALSE) +
  scale_fill_brewer(palette = 'RdYlBu', direction = -1) +
  coord_sf(xlim = display_window[,'X'], 
           ylim = display_window[,'Y'],
           datum = 3310, expand = FALSE) +
  theme_classic2()

Se.w.preds_map

ggsave(here::here('raw_figures/', 'Figure2d_raw.pdf'), 
       plot = Se.w.preds_map, height = 4.5, width = 3, units = 'in')

```


### Gradient boosted

Run gradient boosted model to compare performance

```{r Set Gradient Boosted model controls}
# Same for all
control = 
  trainControl(method = 'repeatedcv', 
               number = 10, # 10 folds
               repeats = 5, # 5 repeated 10-fold CV
               selectionFunction = 'tolerance') # select best model considering
                                      # the % change in RMSE as mtry increases

gb.tunegrid = 
  expand.grid(interaction.depth=c(1, 3, 5), 
              n.trees = (0:50)*50, 
              shrinkage=c(0.01, 0.001),
              n.minobsinnode=10)

```


```{r Train GB RF on log data, message=FALSE, warning=FALSE}

# run Random Forests on log 10 transformed data
As.gb.log = 
  caret::train(As~.,
               data = As.tr.log,
               method = 'gbm', 
               trControl = control, 
               metric = 'RMSE', 
               tuneGrid = gb.tunegrid, 
               na.action = na.omit,
               verbose = FALSE)

Se.gb.log = 
  caret::train(Se~., 
               data = Se.tr.log, 
               method = 'gbm', 
               trControl = control, 
               metric = 'RMSE', 
               tuneGrid = gb.tunegrid, 
               na.action = na.omit,
               verbose = FALSE)

```


```{r GB RF model diagonistics}

GB.results = 
  tibble::tibble(GB = c('As', 'Se')) %>%
  bind_cols(
    bind_rows(
      As.gb.log$results %>%
        filter(n.trees == As.gb.log$bestTune$n.trees & 
                 shrinkage == As.gb.log$bestTune$shrinkage &
                 interaction.depth == As.gb.log$bestTune$interaction.depth),
      Se.gb.log$results %>%
        filter(n.trees == Se.gb.log$bestTune$n.trees & 
                 shrinkage == Se.gb.log$bestTune$shrinkage &
                 interaction.depth == Se.gb.log$bestTune$interaction.depth))) %>%
  dplyr::select(-ends_with('SD')) %>%
  dplyr::mutate(
    across(any_of(c('RMSE', 'MAE')), ~10^.x)) 

knitr::kable(GB.results, caption = 'Gradient Boosted Model Results',
             digits = 3)


```




### Arsenic and Selenium Dynamics in ponds


#### Enrichment Factors

##### Visualize Arsenic, Selenium, and Lithium Levels

Prior to calculating enrichment factors, verify that Li generally follows similar patterns as As and Se.

```{r Visualize As Se and Li concs }

boxplot.dat = 
  bind_rows(
    SJVPondsDat.Clean %>% 
      filter(CBE_flag == 'N') %>%
      dplyr::select(c('Int_ID',  'As', 'Se', 'Li')) %>% 
      dplyr::mutate(
        across(Int_ID, as.character),
        across(As, ~.x*1.334935e-08),
        across(Se, ~.x*1.26646E-08),
        across(Li, ~.x*1.440922e-04), 
        type = 'Pond'),
    CalGEM.WSD.chem %>% 
      filter(abs(CBE) <= 10) %>%
      dplyr::select(c('As', 'Se', 'Li')) %>% 
      dplyr::mutate(
        across(As, ~.x*1.334935e-05),
        across(Se, ~.x*1.26646E-05),
        across(Li, ~.x*1.440922e-04),
        type = 'PW') %>%
      rownames_to_column(var = 'Int_ID')) %>%
  pivot_longer(cols = c(As, Se, Li),
               names_to = 'element', 
               values_to = 'conc')


boxplot.compare = 
  boxplot.dat %>% 
  ggplot(aes(y = conc*1000, x = type)) +
  geom_boxplot(aes(fill = type), show.legend = FALSE) +
  scale_fill_manual(values = c('#bdc9e0', '#74a9ce')) +
  facet_wrap(~element, nrow = 1) +
  scale_y_log10() +
  annotation_logticks(sides = 'l') +
  labs(x = '', y = 'Conc (mM)') +
  theme_classic2()

boxplot.compare

ggsave(here::here('raw_figures/', 'FigureS3_raw.pdf'), 
       plot = boxplot.compare, width = 6, height = 3, units = 'in')

```


The pond concentrations look universally depleted as compared to the wellhead samples. Is this difference statistically significant?

```{r Test significance of pond vs. wellhead}

# Test As
boxplot.dat %>%
  filter(element == 'As') %>%
  pairwise_wilcox_test(conc ~ type, p.adjust.method = 'BH', exact = TRUE)
  
# Test Se
boxplot.dat %>%
  filter(element == 'Se') %>%
  pairwise_wilcox_test(conc ~ type, p.adjust.method = 'BH', exact = TRUE)

# Test Li
boxplot.dat %>%
  filter(element == 'Li') %>%
  pairwise_wilcox_test(conc ~ type, p.adjust.method = 'BH', exact = TRUE)

```


##### Use Enrichment Factors to Determine Enrichment/Depletion

```{r calculate reference ratios for SJV rock}

Rock_As.Li = 
  median((USGS.NGDB.rock$As*1.334935e-05)/(USGS.NGDB.rock$Li*1.440922e-04),
         na.rm = TRUE)
Rock_Se.Li = 
  median((USGS.NGDB.rock$Se*1.26646E-05)/(USGS.NGDB.rock$Li*1.440922e-04), 
         na.rm = TRUE)

```


Are pond waters relatively enriched as compared to local parent materials?

```{r Calc enrichment factors}

EF.dat = 
  bind_rows(
    SJVPondsDat.Clean %>% 
      filter(CBE_flag == 'N') %>%
      dplyr::select(c('Int_ID', 'Oil_Field', 'As', 'Se', 'Li')) %>% 
      dplyr::mutate(
        across(Int_ID, as.character),
        As_EF = ((As*1.334935e-08)/(Li*1.440922e-04))/(Rock_As.Li),
        Se_EF = ((Se*1.26646E-08)/(Li*1.440922e-04))/(Rock_Se.Li),
        type = 'Pond') %>%
      dplyr::select(c('Int_ID', 'Oil_Field', 'type', 'As_EF', 'Se_EF')), 
    CalGEM.WSD.chem %>% 
      filter(abs(CBE) <= 10) %>%
      dplyr::select(c('As', 'Se', 'Li')) %>% 
      dplyr::mutate(
        As_EF = ((As*1.334935e-05)/(Li*1.440922e-04))/(Rock_As.Li),
        Se_EF = ((Se*1.26646E-05)/(Li*1.440922e-04))/(Rock_Se.Li),                    type = 'PW') %>%
      rownames_to_column(var = 'Int_ID') %>%
      dplyr::mutate(Oil_Field = 'All SJV') %>%
      dplyr::select(c('Int_ID', 'Oil_Field', 'type', 'As_EF', 'Se_EF'))) %>% 
  pivot_longer(cols = ends_with('_EF'),
               names_to = 'element', 
               values_to = 'EF')


# output medians
EF.dat %>%
  pivot_wider(id_cols = c(Int_ID, type),
              names_from = 'element',
              values_from = 'EF') %>%
  group_by(type) %>%
  dplyr::summarise(
    med_As = median(As_EF, na.rm = TRUE),
    med_Se = median(Se_EF, na.rm = TRUE)) %>%
  dplyr::mutate(
    across(starts_with('med_'), ~signif(.x, digits = 3)))

```


```{r Plot enrichment factors, message=FALSE, warning=FALSE}

EF.plt = 
  EF.dat %>% 
  ggplot(aes(y = EF, x = type)) +
  geom_hline(yintercept = 1, colour = '#808285') +
  geom_boxplot(aes(fill = type)) +
  scale_fill_manual(values = c('#bdc9e0', '#74a9ce')) +
  geom_jitter(colour = '#ed1c24', size = 0.5) + 
  facet_wrap(~element) +
  scale_y_log10() +
  annotation_logticks(sides = 'l') +
  theme_classic2() 

EF.plt

ggsave(here::here('raw_figures/', 'Figure5_raw.pdf'), 
       plot = EF.plt, width = 6, height = 3, units = 'in')

```

Are any differences statistically significant?

```{r Hypothesis test of EFs}

# Stats
As.EF.wilcox = 
  EF.dat %>% 
  group_by(type) %>% 
  filter(element == 'As_EF') %>%
  drop_na(EF)

pairwise.wilcox.test(As.EF.wilcox$EF, As.EF.wilcox$type,
            p.adjust.method = 'BH', exact = FALSE)


Se.EF.wilcox = 
  EF.dat %>% 
  group_by(type) %>% 
  filter(element == 'Se_EF') %>%
  drop_na(EF)

pairwise.wilcox.test(Se.EF.wilcox$EF, Se.EF.wilcox$type,
            p.adjust.method = 'BH', exact = FALSE)

```


#### Saturation Indicies

To see if precipitation of any As-/Se-bearing minerals is occurring calculate saturation indices in PHREEQC.

```{r Create vector of species to include in PHREEQC}

solution.cols = 
  c('Oil_Field', 'Temp_C', 'pH', 'Alkalinity_CaCO3', 'As',
    'B', 'Ba', 'Br', 'HCO3', 'Ca', 'Cl', 'Fe', 'K', 'Li',
    'Mg', 'Mn', 'Na', 'SO4', 'Se', 'Sr', 'NH3', 'NH4', 'NO3')

```


Given the data gaps in some analytes, restrict simulations to the top 5 in terms of As and Se detections. Samples from these fields compromise ~85% and ~87% of the samples with As and Se detections, respectively.

```{r get detections per field}

# Arsenic
AsTopFive = 
  SJVPondsDat.Clean %>%
  filter(!is.na(As)) %>%
  group_by(Oil_Field) %>%
  dplyr::summarise(count = n()) %>% ungroup() %>%
  arrange(desc(count)) %>% 
  slice_max(count, n = 5) %>% 
  dplyr::mutate(across(Oil_Field, droplevels),
                across(Oil_Field, as.character)) %>%
  pull(Oil_Field)

# Selenium
SeTopFive = 
  SJVPondsDat.Clean %>%
  filter(!is.na(Se)) %>%
  group_by(Oil_Field) %>%
  dplyr::summarise(count = n()) %>% ungroup() %>%
  arrange(desc(count)) %>% 
  slice_max(count, n = 5) %>%
  dplyr::mutate(across(Oil_Field, droplevels),
                across(Oil_Field, as.character)) %>%
  pull(Oil_Field)
  
```


##### Arsenic Saturation Indices 


```{r Calculate SIs in As samples}

# Calculate median values of analytes to calc SIs in PHREEQC
As.samps =
  SJVPondsDat.Clean %>%
  filter(Oil_Field %in% AsTopFive) %>%
  filter(!is.na(As)) %>%
  dplyr::select(any_of(solution.cols)) %>%
  group_by(Oil_Field) %>% 
  dplyr::summarise(across(everything(), ~median(.x, na.rm = TRUE)),
            n = n())

write_csv(As.samps, 
          here::here('geochemical_data/PHREEQC','As_PHREEQCinput.csv'))

```

Saturation Indices were calculated in PHREEQC and the output tabluated

```{r Read and sort As SIs}

As.SIs = 
  read_csv(here::here('geochemical_data/PHREEQC/',
                      'As_SatInds.csv')) %>%
  filter(`SI` > 0) %>%
  dplyr::group_by(Field) %>%
  dplyr::arrange(desc(`SI`), .by_group = TRUE)

```

##### Selenium Saturation Indices 

```{r Calculate SIs in Se samples}

# Calculate median values of analytes to calc SIs in PHREEQC
Se.samps =
  SJVPondsDat.Clean %>%
  filter(Oil_Field %in% SeTopFive) %>%
  filter(!is.na(Se)) %>%
  dplyr::select(any_of(solution.cols)) %>%
  group_by(Oil_Field) %>% 
  dplyr::summarise(across(everything(), ~median(.x, na.rm = TRUE)),
            n = n())

write_csv(Se.samps, 
          here::here('geochemical_data/PHREEQC','Se_PHREEQCinput.csv'))

```


```{r Read and sort As SIs}

Se.SIs = 
  read_csv(here::here('geochemical_data/PHREEQC/',
                      'Se_SatInds.csv')) %>%
  filter(`SI` > 0) %>%
  dplyr::group_by(Field) %>%
  dplyr::arrange(desc(`SI`), .by_group = TRUE)


```


#### Evaporative Effects

##### Arsenic Evaporative Effects

Arsenic is related to SC, TDS, and Cl. Is arsenic being evapoconcentrated?

How do As concentrations compare to 2H?

```{r Generate Figure 4}

As_H2.all.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(As)) %>%
  ggplot(aes(x = As, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(alpha = 0.4) +
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  theme_classic2()

As_H2.all.plt

ggsave(here::here('raw_figures/', 'Figure4a_raw.pdf'), 
       plot = As_H2.all.plt, width = 3, height = 3, units = 'in')

As_H2.sub.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(As)) %>%
  filter(Oil_Field %in% c('BELGIAN ANTICLINE', 'ANTELOPE HILLS')) %>%
  dplyr::mutate(across(Oil_Field, droplevels)) %>%
  ggplot(aes(x = As, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point() + 
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  facet_wrap(~Oil_Field, scales = "free_y", ncol = 2) +
  xlim(0,150) +
  theme_classic2()

As_H2.sub.plt

ggsave(here::here('raw_figures/', 'Figure4bc_raw.pdf'), 
       plot = As_H2.sub.plt, width = 6, height = 3, units = 'in')

```


```{r  Create Figure S11, message=FALSE, warning=FALSE}

# As vs. Cl for entire SJV
As_Cl.all.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot(aes(x = (Cl/35.45), y = (As*1.334935e-05))) +
  geom_smooth(method = 'lm', se = FALSE, colour = '#414042') +
  geom_point(alpha = 0.4) +
  stat_regline_equation(aes(label = ..eq.label..)) +
  stat_regline_equation(aes(label = ..rr.label..)) +
  scale_y_log10() +
  scale_x_log10(limits = c(1, 5000)) +
  annotation_logticks(sides = 'lb') +
  labs(title = '', x = 'Cl (mM)', y = 'As (mM)') +
  theme_classic2()

As_Cl.all.plt

ggsave(here::here('raw_figures/', 'FigureS11a_raw.pdf'), 
       plot = As_Cl.all.plt, width = 3, height = 3, units = 'in')

# As vs. Cl for western SJV

As_Cl.west.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(AxisSide != 'East') %>%
  ggplot(aes(x = (Cl/35.45), y = (As*1.334935e-05))) +
  geom_smooth(method = 'lm', se = FALSE, colour = '#414042') +
  geom_point(alpha = 0.4) +
  stat_regline_equation(aes(label = ..eq.label..)) +
  stat_regline_equation(aes(label = ..rr.label..)) +
  scale_y_log10() +
  scale_x_log10(limits = c(1, 5000)) +
  annotation_logticks(sides = 'lb') +
  labs(title = '', x = 'Cl (mM)', y = 'As (mM)') +
  theme_classic2()

As_Cl.west.plt

ggsave(here::here('raw_figures/', 'FigureS11b_raw.pdf'), 
       plot = As_Cl.west.plt, width = 3, height = 3, units = 'in')

```


##### Selenium Evaporative Effects

Selenium is also related to SC, TDS, and Cl. Is selenium being evapoconcentrated?

How do Se concentrations compare to 2H?

```{r Look at evaporation vs Se}

Se_H2.all.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(Se)) %>%
  ggplot(aes(x = Se, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(alpha = 0.4) +
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  theme_classic2()

Se_H2.all.plt

ggsave(here::here('raw_figures/', 'Figure6a_raw.pdf'), 
       plot = Se_H2.all.plt, width = 3, height = 3, units = 'in')

Se_H2.sub.plt = 
  SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  filter(Oxygen_18 > -15) %>%
  filter(!is.na(Se)) %>%
  filter(Oil_Field %in% c('BELGIAN ANTICLINE', 'ANTELOPE HILLS')) %>%
  dplyr::mutate(across(Oil_Field, droplevels)) %>%
  ggplot(aes(x = Se, y = Deuterium)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point() + 
  stat_regline_equation(label.y = 5, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 0, aes(label = ..rr.label..)) +
  facet_wrap(~Oil_Field, scales = "free", ncol = 2) +
  theme_classic2()

Se_H2.sub.plt

ggsave(here::here('raw_figures/', 'Figure6bc_raw.pdf'), 
       plot = Se_H2.sub.plt, width = 6, height = 3, units = 'in')

```


#### Examine Selenium Relationships

```{r Create Figure S12, message=FALSE, warning=FALSE}

# Se vs. Alkalinity
SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot(aes(x = Alkalinity_CaCO3, y = Se)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(fill = '#a7a9ac', colour = 'black', 
             shape = 21, stroke = 0.2) + 
  stat_regline_equation(label.y = 3, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 2.75, aes(label = ..rr.label..)) +
  scale_y_log10() + scale_x_log10() +
  annotation_logticks(sides = "lb") + 
  theme_classic2()

ggsave(here::here('raw_figures/','FigureS12a_raw.pdf'),
       plot = last_plot(), width = 3, height = 3, units = 'in')

# Se vs. Li
SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot(aes(x = Li, y = Se)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(fill = '#a7a9ac', colour = 'black', 
             shape = 21, stroke = 0.2) +
  stat_regline_equation(label.y = 3, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 2.75, aes(label = ..rr.label..)) +
  scale_x_log10() + scale_y_log10() +
  annotation_logticks(sides = "lb") +
  theme_classic2()

ggsave(here::here('raw_figures/','FigureS12b_raw.pdf'),
       plot = last_plot(), width = 3, height = 3, units = 'in')

# Se vs. Br
SJVPondsDat.Clean %>%
  filter(CBE_flag == 'N') %>%
  ggplot(aes(x = Br, y = Se)) +
  geom_smooth(method = 'lm', se = FALSE, colour = 'black') +
  geom_point(fill = '#a7a9ac', colour = 'black', 
             shape = 21, stroke = 0.2) +
  stat_regline_equation(label.y = 3, aes(label = ..eq.label..)) +
  stat_regline_equation(label.y = 2.75, aes(label = ..rr.label..)) +
  scale_x_log10() + scale_y_log10() +
  annotation_logticks(sides = "lb") +
  theme_classic2()

ggsave(here::here('raw_figures/','FigureS12c_raw.pdf'),
       plot = last_plot(), width = 3, height = 3, units = 'in')

```
